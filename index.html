<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¦¹å¦¹ä¸­æ–‡å­¸ç¿’è¨˜éŒ„å™¨ - é­”æ³•å¤§å¸«æœ€çµ‚ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF7EB9; /* è‰è“ç²‰ */
            --primary-dark: #FF5A9D;
            --secondary: #B983FF; /* æŸ”å’Œç´« */
            --bg-gradient: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            --white: #ffffff;
            --text: #5D4037;
            --danger: #FF6B6B;  /* å¿˜è¨˜ - ç´… */
            --warning: #FF9F43; /* å›°é›£ - æ©˜ */
            --info: #48DBFB;    /* è¨˜å¾— - è— */
            --success: #7ED957;  /* å¤ªç°¡å–® - ç¶  */
            --gold: #FFD700;
            
            /* Familiarity Tier Colors */
            --color-new: #ffffff;      
            --color-learning: #FFD1DC; 
            --color-review: #FAD0C4;   
            --color-mastered: #E2D5F0; 
            --color-mature: #FFDAB9;   
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; }

        /* éš±è—å…ƒä»¶ä¿®å¾© */
        .hidden { display: none; }

        /* å¤§æ¨™é¡Œå€ */
        .app-header { text-align: center; margin-bottom: 15px; padding-top: 10px; }
        .app-title {
            font-size: 26px; font-weight: 800; color: var(--primary);
            margin: 0; text-shadow: 2px 2px 0px white;
        }

        /* Stats Card */
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 28px; padding: 15px;
            box-shadow: 0 10px 30px rgba(255, 126, 185, 0.15);
            margin-bottom: 12px; border: 2.5px solid #FFD1DC; text-align: center;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--primary); font-family: 'Fredoka'; }
        .stat-label { font-size: 11px; color: #8d6e63; font-weight: 600; }
        .streak-fire { color: #FF4D6D; animation: fire-pulse 1.5s infinite; }
        
        @keyframes fire-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .familiarity-bar { height: 10px; background: #eee; border-radius: 10px; display: flex; overflow: hidden; margin-top: 10px; border: 1px solid #fff; }
        .fam-seg { height: 100%; transition: width 0.6s ease; }

        /* Dashboard Layout */
        .dashboard-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: stretch; }

        /* Monthly Calendar */
        .calendar-section {
            background: white; border-radius: 24px; padding: 12px;
            border: 2px solid #FFD1DC; box-shadow: 0 4px 15px rgba(255, 126, 185, 0.05);
            flex: 1.2; min-width: 300px;
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .calendar-nav { display: flex; align-items: center; gap: 8px; }
        .nav-btn { background: none; border: none; font-size: 16px; color: var(--primary); cursor: pointer; padding: 2px; }
        .calendar-title { font-size: 13px; font-weight: 700; color: var(--primary); cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-weekday { font-size: 9px; color: #A1887F; text-align: center; font-weight: bold; padding-bottom: 4px; }
        .calendar-day {
            aspect-ratio: 1; border-radius: 8px; border: 1px solid #FFFafb;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: #ddd; background: #fafafa; position: relative;
            font-family: 'Fredoka', sans-serif;
        }
        .calendar-day.active { background: var(--color-learning); border-color: var(--primary); }
        .calendar-day.today { border: 1.5px solid var(--secondary); color: var(--secondary); font-weight: 900; }
        .calendar-day .day-icon { 
            font-size: 26px; position: absolute; z-index: 2; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        .calendar-day span:not(.day-icon) { z-index: 1; opacity: 0.3; }
        .calendar-day.empty { background: transparent; border: none; }

        /* Reward Area - ä¿®æ­£ï¼šå›ºå®šé«˜åº¦é˜²æ­¢æº¢å‡º */
        .reward-area {
            background: white; border-radius: 24px; padding: 15px;
            border: 2px solid #FFD1DC; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 126, 185, 0.05);
            flex: 1; min-width: 300px; display: flex; flex-direction: column; justify-content: center;
            overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }
        
        /* ä¿®æ­£ï¼šè²¼ç´™é è¦½å€å›ºå®šé«˜åº¦ï¼Œè¶…éé¡¯ç¤ºçœç•¥ */
        .sticker-preview { 
            display: flex; 
            gap: 8px; 
            padding-bottom: 12px; 
            height: 50px; /* å›ºå®šé«˜åº¦ */
            min-height: 50px;
            max-height: 50px;
            align-items: center; 
            overflow: hidden; /* éš±è—è¶…å‡ºéƒ¨åˆ† */
            flex-wrap: nowrap; /* ä¸æ›è¡Œ */
        }
        
        .star-meter-container { display: flex; flex-direction: column; align-items: center; gap: 6px; padding-top: 12px; border-top: 1.5px dashed #FFF0F5; }
        .star-box { font-size: 16px; color: var(--gold); display: flex; gap: 1px; }

        /* Actions */
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .btn {
            border: none; border-radius: 18px; padding: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: white; border: 1.5px solid #FFD1DC; color: var(--primary); }
        .btn-review-alert { background: #FF4D6D; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Input Section */
        .input-section { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .input-box { background: white; padding: 10px; border-radius: 20px; border: 2px solid #FFD1DC; }
        .input-box input { width: 100%; border: none; padding: 8px; font-size: 14px; outline: none; background: #fffafb; border-radius: 12px; margin-bottom: 8px; }

        /* Grid */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; }
        .char-card {
            background: white; border-radius: 22px; padding: 12px 5px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
            aspect-ratio: 1/1.2; display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.3s;
        }
        .char-text { font-weight: 700; color: #4E342E; width: 95%; word-break: break-all; line-height: 1.2; margin-bottom: 4px; }
        .review-date { font-size: 8px; color: #A1887F; font-family: 'Fredoka'; opacity: 0.8; }

        /* Modal Layout */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 240, 245, 0.98); display: none;
            align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(15px);
        }
        .modal-content {
            background: white; border-radius: 40px; width: 95%; max-width: 550px;
            min-height: min(550px, 90vh); padding: 30px 20px; position: relative;
            box-shadow: 0 20px 60px rgba(255, 126, 185, 0.25); border: 5px solid var(--primary);
            display: flex; flex-direction: column; align-items: stretch; overflow-y: auto; max-height: 90vh;
            -webkit-overflow-scrolling: touch; /* iOS æ²å‹•æ…£æ€§ */
        }
        .flashcard-main { font-weight: 700; color: var(--text); text-shadow: 6px 6px 0px #FFD1DC; flex-grow: 1; display: flex; align-items: center; justify-content: center; line-height: 1.1; text-align: center; width: 100%; }

        .srs-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1.5px solid #FFF0F5; }
        .srs-btn { border: none; padding: 12px 2px; border-radius: 16px; font-weight: 700; cursor: pointer; color: white; font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .srs-btn span { font-size: 8px; font-weight: 400; opacity: 0.9; }
        .btn-again { background: var(--danger); } .btn-hard { background: var(--warning); } .btn-good { background: var(--info); } .btn-easy { background: var(--success); }

        .guide-section { text-align: left; width: 100%; color: #5D4037; padding-bottom: 20px; }
        .guide-section h3 { color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; margin: 24px 0 12px 0; font-size: 16px; }
        .guide-section p { font-size: 13.5px; line-height: 1.7; background: #fffafa; padding: 12px; border-radius: 15px; border: 1px solid #FFF0F5; }
        .logic-tag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; margin: 3px; font-weight: bold; background: white; border: 1px solid #ddd; }
        
        .wish-item { background: #fff; border: 1px solid #FFD1DC; border-radius: 15px; padding: 12px; margin-bottom: 10px; width: 100%; }
        .wish-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; color: #5D4037; margin-bottom: 5px; }
        .wish-progress-bg { height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
        .wish-progress-fill { height: 100%; background: var(--primary); transition: width 1s ease; }

        .confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 16px; border-radius: 20px; background: white; border: 1.5px solid #FFD1DC; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; background: var(--text); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; }

        /* ä¿®æ­£ï¼šè²¼ç´™ç‰† Modal å°ˆç”¨æ¨£å¼ */
        .sticker-wall-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-height: 0; /* é‡è¦ï¼šå…è¨± flex å­å…ƒç´ æ”¶ç¸® */
        }
        
        .sticker-wall-header {
            flex-shrink: 0;
            text-align: center;
            padding-bottom: 10px;
            width: 100%;
        }
        
        .sticker-grid-wrapper {
            flex: 1;
            min-height: 160px;
            max-height: none;      /* ä¸é™é«˜åº¦ */
            overflow: visible;     /* äº¤çµ¦å¤–å±¤ modal çµ±ä¸€æ²å‹• */
            padding: 15px 0;
            border-bottom: 2px dashed #FFF0F5;
            margin-bottom: 15px;
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
        }
        
        .wish-section {
            flex-shrink: 0;
            background: #FFF0F5;
            padding: 20px;
            border-radius: 28px;
            /* ä¸è¨­ max-height å’Œ overflowï¼Œè®“æ²å‹•åªåœ¨ modal å±¤ç´š */
        }

        @media (max-width: 768px) {
            .dashboard-row { flex-direction: column; }
            .input-section { grid-template-columns: 1fr; }
            .items-grid { grid-template-columns: repeat(3, 1fr); }
            
            /* é—œéµä¿®æ­£ï¼šæ‰‹æ©Ÿç‰ˆå–æ¶ˆ flex åˆ†é…ï¼Œæ ¹æ²»æ—¥æ›†è¦†è“‹è²¼ç´™å•é¡Œ */
            .calendar-section,
            .reward-area {
                flex: 0 0 auto;
                min-width: 0;
                height: auto;
            }
            .reward-area {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸŒ¸ å¦¹å¦¹çš„èªå­—å†’éšª</h1>
    </div>

    <!-- Stats Header -->
    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item"><span class="stat-value en-num" id="total-count">0</span><span class="stat-label">æŒ‘æˆ°ç¸½æ•¸</span></div>
            <div class="stat-item"><span class="stat-value en-num" id="review-count">0</span><span class="stat-label">å¾…è¤‡ç¿’</span></div>
            <div class="stat-item"><span class="stat-value en-num streak-fire" id="streak-count">0</span><span class="stat-label">é€£å‹å¤©æ•¸</span></div>
        </div>
        <div class="familiarity-bar" id="fam-bar"></div>
    </div>

    <!-- Dashboard: Calendar & Rewards -->
    <div class="dashboard-row">
        <div class="calendar-section" id="adventure-calendar">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)">â®</button>
                    <div class="calendar-title" id="calendar-title" onclick="resetCalendarView()">å†’éšªæœˆæ›†</div>
                    <button class="nav-btn" onclick="changeMonth(1)">â¯</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="reward-area" onclick="openStickerWall()">
            <div class="sticker-preview" id="sticker-preview">
                <span style="font-size: 12px; color: #FF7EB9; font-weight: 700;">è²¼ç´™ç°¿ï¼š</span>
            </div>
            <div class="star-meter-container">
                <span style="font-size: 10px; color: #8d6e63;">å†å¾— <strong id="stars-needed" style="color:var(--primary)">10</strong> é¡†æ˜Ÿå°±æœ‰è²¼ç´™ï¼</span>
                <div class="star-box" id="star-box"></div>
            </div>
        </div>
    </div>

    <div class="action-grid">
        <button class="btn btn-primary" onclick="startReviewSession()" id="start-review-btn">âœ¨ é–‹å§‹å†’éšªè¤‡ç¿’</button>
        <button class="btn btn-secondary" onclick="startQuizSession()" id="start-quiz-btn">ğŸ¯ è¾¨è­˜å¤§æŒ‘æˆ°</button>
        <button class="btn btn-outline" onclick="openParentalGuide()">ğŸ“– å®¶é•·èªªæ˜</button>
        <button class="btn btn-outline" onclick="openSimilarManager()">âš™ï¸ ç›¸è¿‘å­—ç®¡ç†</button>
    </div>

    <div class="input-section">
        <div class="input-box">
            <span style="font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 5px; display: block;">ğŸ“– åŠ å…¥å–®å­—</span>
            <input type="text" id="add-char-input" placeholder="å¤©ã€åœ°">
            <button class="btn btn-primary" style="width:100%; padding: 8px;" onclick="quickAdd('char')">åŠ å…¥å­—åº«</button>
        </div>
        <div class="input-box">
            <span style="font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 5px; display: block;">ğŸˆ åŠ å…¥è©èª</span>
            <input type="text" id="add-word-input" placeholder="å¤ªé™½ã€è´è¶">
            <button class="btn btn-primary" style="width:100%; padding: 8px; background:var(--secondary);" onclick="quickAdd('word')">åŠ å…¥è©åº«</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('all', this)">å…¨éƒ¨æ¸…å–®</div>
        <div class="tab" onclick="setTab('review', this)">ä»Šå¤©è¦è®€</div>
        <div class="tab" onclick="setTab('words', this)">åªçœ‹è©èª</div>
    </div>

    <div class="items-grid" id="main-list"></div>

    <div style="margin-top: 40px; text-align: center; opacity: 0.3;">
        <button onclick="exportData()" style="background:none; border:1px solid #ccc; font-size:10px; padding:6px 12px; border-radius:8px;">ğŸ“¥ å‚™ä»½é€²åº¦</button>
        <button onclick="document.getElementById('import-input').click()" style="background:none; border:1px solid #ccc; font-size:10px; padding:6px 12px; border-radius:8px;">ğŸ“¤ è¼‰å…¥ç´€éŒ„</button>
        <input type="file" id="import-input" class="hidden" accept=".json" onchange="importData(event)">
    </div>
</div>

<canvas id="confetti" class="confetti-canvas"></canvas>
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content" id="modal-content"></div>
</div>
<div id="notification-container"></div>

<script>
    // --- Global Helpers ---
    // ä¿®æ­£æ™‚å€å•é¡Œï¼šä½¿ç”¨æœ¬åœ°æ—¥æœŸå­—ä¸²
    function localDateStr(d = new Date()) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    // æ—¥æœŸåŠ æ¸›ï¼ˆç”¨æ–¼ streak è¨ˆç®—ï¼‰
    function addDays(dateStr, delta) {
        const d = new Date(dateStr + "T00:00:00");
        d.setDate(d.getDate() + delta);
        return localDateStr(d);
    }

    // XSS é˜²è­·ï¼šHTML escape
    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    // æ•¸å€¼ clampï¼ˆç”¨æ–¼åŒ¯å…¥è³‡æ–™ç¯„åœé™åˆ¶ï¼‰
    function clamp(n, min, max) {
        n = Number(n);
        if (!Number.isFinite(n)) return min;
        return Math.min(max, Math.max(min, n));
    }

    // ç¢ºä¿å­—å­˜åœ¨æ–¼å­—åº«ï¼ˆç”¨æ–¼ Quiz ç­”å°æ™‚ç™¼æ˜Ÿï¼‰
    function ensureCharExists(ch) {
        if (!state.characters[ch]) {
            state.characters[ch] = { interval: 0, ease: 2.5, reps: 0, nextReview: Date.now(), lastStarDate: null, lastSRSDate: null };
        }
        return state.characters[ch];
    }

    // æ¸…æ´—è¼¸å…¥å­—ä¸²ï¼šå»æ‰é€—è™Ÿã€é “è™Ÿã€ç©ºç™½ç­‰åˆ†éš”ç¬¦
    function normalizeInputChars(str) {
        return str.replace(/[ï¼Œ,ã€\s]+/g, '');
    }

    function getCardColor(i) {
        if (i > 30) return 'var(--color-mature)';
        if (i > 10) return 'var(--color-mastered)';
        if (i > 3) return 'var(--color-review)';
        if (i > 0) return 'var(--color-learning)';
        return 'var(--color-new)';
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = Array.from({length: 120}, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * 100,
            color: `hsl(${Math.random() * 360}, 100%, 75%)`,
            tilt: Math.random() * 10 - 10
        }));
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color;
                ctx.moveTo(p.x + p.tilt + p.r / 2, p.y);
                ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
                ctx.stroke();
                p.y += Math.cos(p.d) + 1 + p.r / 2;
                p.x += Math.sin(p.d) * 2;
                if (p.y > canvas.height) { p.y = -20; p.x = Math.random() * canvas.width; }
            });
        }
        let frame = 0;
        const anim = setInterval(() => { 
            draw(); frame++; 
            if (frame > 200) { 
                clearInterval(anim); 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            } 
        }, 20);
    }

    // --- Data State ---
    const APP_ID = 'sister-chinese-magic-master-stable';
    let state = {
        characters: {}, words: {}, similarPairs: [], stickers: [], currentStars: 0,
        streak: 0, lastActivityDate: null, dailyHistory: {}, wishes: []
    };
    
    // ===== SEEDED_STATE: é è¨­å­¸ç¿’é€²åº¦ï¼ˆç•¶ localStorage ç„¡è³‡æ–™æ™‚ä½¿ç”¨ï¼‰=====
    const SEEDED_STATE = {"characters":{"ä¸Š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891565772,"lastStarDate":"2026-01-27"},"ä¸‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891578509,"lastStarDate":"2026-01-27"},"ä¸":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891554611,"lastStarDate":"2026-01-27"},"ä¸Ÿ":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638652287,"lastStarDate":"2026-01-27"},"ä¹³":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"äº®":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638784108,"lastStarDate":"2026-01-27"},"ä½©":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892518257,"lastStarDate":"2026-01-27"},"ä¾†":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638790909,"lastStarDate":"2026-01-27"},"å€‹":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å„ª":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å…¬":{"interval":6,"ease":2.65,"reps":2,"nextReview":1770070560422,"lastStarDate":"2026-01-27"},"å†°":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638777640,"lastStarDate":"2026-01-27"},"å†·":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892522191,"lastStarDate":"2026-01-27"},"å‰ª":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å‹•":{"interval":1,"ease":2.3,"reps":1,"nextReview":1769638472006,"lastStarDate":"2026-01-27"},"å»":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897863421,"lastStarDate":"2026-01-27"},"å‹":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å£":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891609725,"lastStarDate":"2026-01-27"},"åƒ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891972423,"lastStarDate":"2026-01-27"},"å‘€":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897968655,"lastStarDate":"2026-01-27"},"å‘†":{"interval":1,"ease":2.35,"reps":1,"nextReview":1769632891912,"lastStarDate":"2026-01-27"},"å“ˆ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892226797,"lastStarDate":"2026-01-27"},"å•Š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891663508,"lastStarDate":"2026-01-27"},"å–":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å–µ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892084793,"lastStarDate":"2026-01-27"},"å˜´":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638675173,"lastStarDate":"2026-01-27"},"å››":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891892443,"lastStarDate":"2026-01-27"},"åœ’":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"åœŸ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891827017,"lastStarDate":"2026-01-27"},"åœ°":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891905944,"lastStarDate":"2026-01-27"},"å¤š":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å¤ª":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891894893,"lastStarDate":"2026-01-27"},"å¥³":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891833884,"lastStarDate":"2026-01-27"},"å§¨":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638762771,"lastStarDate":"2026-01-27"},"å­":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891921464,"lastStarDate":"2026-01-27"},"å­©":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å®›":{"interval":1,"ease":2.35,"reps":1,"nextReview":1769632700995,"lastStarDate":"2026-01-27"},"å°‘":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891829801,"lastStarDate":"2026-01-27"},"å°¿":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892320310,"lastStarDate":"2026-01-27"},"å±±":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891836101,"lastStarDate":"2026-01-27"},"å¸«":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891976939,"lastStarDate":"2026-01-27"},"å¸½":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891845403,"lastStarDate":"2026-01-27"},"å¼Ÿ":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"å¿ƒ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891840185,"lastStarDate":"2026-01-27"},"å¿«":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"æ„›":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891927632,"lastStarDate":"2026-01-27"},"æˆ‘":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891908330,"lastStarDate":"2026-01-27"},"æ‰‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891858888,"lastStarDate":"2026-01-27"},"æ‰“":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891911881,"lastStarDate":"2026-01-27"},"æ¬":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891854054,"lastStarDate":"2026-01-27"},"æ›¸":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"æœ‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891848619,"lastStarDate":"2026-01-27"},"æœ¨":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891985423,"lastStarDate":"2026-01-27"},"æ±":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892100945,"lastStarDate":"2026-01-27"},"æœ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891862488,"lastStarDate":"2026-01-27"},"æ¡ƒ":{"interval":0,"ease":2.0999999999999996,"reps":0,"nextReview":1769552337434,"lastStarDate":null},"æ¡Œ":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632483094,"lastStarDate":"2026-01-27"},"æ¨‚":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891930598,"lastStarDate":"2026-01-27"},"æ©˜":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892230196,"lastStarDate":"2026-01-27"},"æ­Œ":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632492746,"lastStarDate":"2026-01-27"},"æ°´":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891673675,"lastStarDate":"2026-01-27"},"æ³¨":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"æ´—":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892535627,"lastStarDate":"2026-01-27"},"æ½¤":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892005998,"lastStarDate":"2026-01-27"},"æ¿•":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891933849,"lastStarDate":"2026-01-27"},"ç‚’":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891989074,"lastStarDate":"2026-01-27"},"ç…®":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891996992,"lastStarDate":"2026-01-27"},"ç‰™":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892029915,"lastStarDate":"2026-01-27"},"ç‹—":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892531860,"lastStarDate":"2026-01-27"},"çŒ©":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892048617,"lastStarDate":"2026-01-27"},"çŒ´":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891754624,"lastStarDate":"2026-01-27"},"ç©":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892233831,"lastStarDate":"2026-01-27"},"çƒ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891776257,"lastStarDate":"2026-01-27"},"ç”Ÿ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892237732,"lastStarDate":"2026-01-27"},"ç”·":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892035248,"lastStarDate":"2026-01-27"},"ç•«":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638805227,"lastStarDate":"2026-01-27"},"ç—…":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"ç™½":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638867114,"lastStarDate":"2026-01-27"},"çš®":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892243784,"lastStarDate":"2026-01-27"},"çœ‰":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632501413,"lastStarDate":"2026-01-27"},"çŸ³":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891780509,"lastStarDate":"2026-01-27"},"ç¬‘":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891764823,"lastStarDate":"2026-01-27"},"ç­†":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632558737,"lastStarDate":"2026-01-27"},"ç­·":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632925831,"lastStarDate":"2026-01-27"},"ç±³":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897733049,"lastStarDate":"2026-01-27"},"ç²‰":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632588291,"lastStarDate":"2026-01-27"},"ç´…":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891768456,"lastStarDate":"2026-01-27"},"ç¶ ":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769638840075,"lastStarDate":"2026-01-27"},"ç¾Š":{"interval":1,"ease":2.5,"reps":1,"nextReview":1769632592543,"lastStarDate":"2026-01-27"},"è€":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891771490,"lastStarDate":"2026-01-27"},"è€³":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892130766,"lastStarDate":"2026-01-27"},"è‚‰":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769891796027,"lastStarDate":"2026-01-27"},"è‚š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892540407,"lastStarDate":"2026-01-27"},"èˆ":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"è‰²":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"èŠ’":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"èŠ±":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892135067,"lastStarDate":"2026-01-27"},"è‰":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892054067,"lastStarDate":"2026-01-27"},"è‘¡":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892248600,"lastStarDate":"2026-01-27"},"è—":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897816347,"lastStarDate":"2026-01-27"},"è˜‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897821548,"lastStarDate":"2026-01-27"},"è›‡":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892254100,"lastStarDate":"2026-01-27"},"å¼•":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"è±†":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892142434,"lastStarDate":"2026-01-27"},"è±¬":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892158522,"lastStarDate":"2026-01-27"},"è²“":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897715832,"lastStarDate":"2026-01-27"},"è²·":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892145302,"lastStarDate":"2026-01-27"},"èµ·":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"è·³":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892162821,"lastStarDate":"2026-01-27"},"è»Š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892547345,"lastStarDate":"2026-01-27"},"é":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é…ª":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é‹¼":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892260769,"lastStarDate":"2026-01-27"},"éŒ¢":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é–‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892434975,"lastStarDate":"2026-01-27"},"é˜¿":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892268067,"lastStarDate":"2026-01-27"},"é›":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é›ª":{"interval":1,"ease":2.35,"reps":1,"nextReview":1769638714397,"lastStarDate":"2026-01-27"},"é›»":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892333096,"lastStarDate":"2026-01-27"},"é‹":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é ­":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892550696,"lastStarDate":"2026-01-27"},"é£›":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897638720,"lastStarDate":"2026-01-27"},"é£½":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892274421,"lastStarDate":"2026-01-27"},"é¤…":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892337980,"lastStarDate":"2026-01-27"},"é¤Š":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é¦¬":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892556363,"lastStarDate":"2026-01-27"},"é«˜":{"interval":1,"ease":2.15,"reps":1,"nextReview":1769638752654,"lastStarDate":"2026-01-27"},"é«®":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é¬†":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892437945,"lastStarDate":"2026-01-27"},"é­š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892357898,"lastStarDate":"2026-01-27"},"é´¨":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é¹¿":{"interval":4,"ease":2.4499999999999997,"reps":1,"nextReview":1769897782109,"lastStarDate":"2026-01-27"},"é»ƒ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897792743,"lastStarDate":"2026-01-27"},"é»‘":{"interval":0,"ease":2.3,"reps":0,"nextReview":1769552460480,"lastStarDate":null},"é¼ ":{"interval":0,"ease":2.5,"reps":0,"nextReview":1769545775024,"lastStarDate":null},"é¼»":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892365484,"lastStarDate":"2026-01-27"},"èˆ¹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897642270,"lastStarDate":"2026-01-27"},"é¦™":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892368802,"lastStarDate":"2026-01-27"},"ä¸€":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892371867,"lastStarDate":"2026-01-27"},"ä¸‰":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892388554,"lastStarDate":"2026-01-27"},"äºŒ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892450847,"lastStarDate":"2026-01-27"},"äº”":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892385520,"lastStarDate":"2026-01-27"},"äºº":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892380354,"lastStarDate":"2026-01-27"},"å…”":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892443830,"lastStarDate":"2026-01-27"},"å“¥":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892446594,"lastStarDate":"2026-01-27"},"å":{"interval":4,"ease":2.4499999999999997,"reps":1,"nextReview":1769897755571,"lastStarDate":"2026-01-27"},"å¤§":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892559230,"lastStarDate":"2026-01-27"},"å¦¹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892448615,"lastStarDate":"2026-01-27"},"åª½":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897644904,"lastStarDate":"2026-01-27"},"å°":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892577951,"lastStarDate":"2026-01-27"},"æ˜Ÿ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897647921,"lastStarDate":"2026-01-27"},"æœˆ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892454698,"lastStarDate":"2026-01-27"},"ç«":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892461015,"lastStarDate":"2026-01-27"},"ç†Š":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892457296,"lastStarDate":"2026-01-27"},"çˆ¸":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769892463349,"lastStarDate":"2026-01-27"},"èœ":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897651772,"lastStarDate":"2026-01-27"},"è›‹":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897654939,"lastStarDate":"2026-01-27"},"é†«":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897658490,"lastStarDate":"2026-01-27"},"é–€":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897663707,"lastStarDate":"2026-01-27"},"é£¯":{"interval":4,"ease":2.65,"reps":1,"nextReview":1769897667543,"lastStarDate":"2026-01-27"}},"words":{},"similarPairs":[],"stickers":["ğŸ¦‹","ğŸ“","ğŸ’","ğŸ°","ğŸŒ¸","ğŸŒ™","ğŸ§","ğŸ¦","ğŸŒ™","ğŸ©°","ğŸˆ","ğŸ’","ğŸ©°"],"currentStars":0,"streak":1,"lastActivityDate":"2026-01-27","dailyHistory":{"2026-01-27":true},"wishes":[{"id":1769551876557,"text":"å»åšç‰©é¤¨ï¼","count":50}]};
    
    // ===== åˆå§‹åŒ–æ¨™è¨˜ï¼ˆåƒ…ç”¨æ–¼è¨˜éŒ„æ˜¯å¦æ›¾åˆå§‹åŒ–éï¼Œä¸å½±éŸ¿ seed è¡Œç‚ºï¼‰=====
    const SEED_FLAG = APP_ID + ':seed_applied_v2026_01_27';
    
    let currentViewDate = new Date();
    let currentTab = 'all', reviewQueue = [];
    let quizData = { current: 0, total: 0, score: 0 };
    const STICKER_POOL = ["ğŸ¦„", "ğŸ‘¸", "ğŸ­", "ğŸ¡", "ğŸ°", "ğŸ§œâ€â™€ï¸", "ğŸ§š", "ğŸ¦‹", "ğŸŒˆ", "ğŸ§", "ğŸ€", "ğŸ±", "ğŸ°", "ğŸ©°", "ğŸ’", "ğŸ“", "ğŸŒ¸", "â­", "ğŸŒ™", "ğŸ¦‰", "ğŸ¨", "ğŸ¦", "ğŸˆ", "ğŸ‘’"];

    // ===== å¯èª¿æ•´çš„å¸¸æ•¸ =====
    const STAR_TARGET = 10;              // é›†æ»¿å¹¾é¡†æ˜Ÿæ›è²¼ç´™
    const STICKER_MAX = 200;             // è²¼ç´™ç‰†ä¸Šé™
    const HISTORY_DAYS = 365;            // dailyHistory ä¿ç•™å¤©æ•¸
    const QUIZ_MAX_Q = 10;               // è¾¨è­˜å¤§æŒ‘æˆ°æœ€å¤šå¹¾é¡Œ
    const HARD_REVIEW_MS = 2 * 60 * 60 * 1000;   // å›°é›£ï¼š2 å°æ™‚å¾Œå†çœ‹
    const MIN_REVIEW_GAP_MS = 5 * 60 * 1000;     // æœ€å°é–“éš”ï¼š5 åˆ†é˜

    // ===== æ­£è¦åŒ– Stateï¼ˆè£œé½Šç¼ºæ¬„ä½ã€é©—è­‰è³‡æ–™æ ¼å¼ï¼‰=====
    function normalizeState(inputState) {
        console.log('[normalizeState] é–‹å§‹é©—è­‰èˆ‡æ­£è¦åŒ–...');
        
        // é™åˆ¶èªªæ˜ï¼šJSON ç‰©ä»¶è§£æå¾Œé‡è¤‡ key æœƒè¢«è¦†è“‹ï¼Œç„¡æ³•åœ¨æ­¤åµæ¸¬åŸå§‹é‡è¤‡
        // è‹¥éœ€åµæ¸¬ï¼Œè«‹åœ¨è²¼å…¥ JSON å­—ä¸²å‰ä½¿ç”¨ regex æƒæ
        
        // Deep copy
        const result = JSON.parse(JSON.stringify(inputState));
        
        // é è¨­çµæ§‹
        const defaultStructure = {
            characters: {},
            words: {},
            similarPairs: [],
            stickers: [],
            currentStars: 0,
            streak: 0,
            lastActivityDate: null,
            dailyHistory: {},
            wishes: []
        };
        
        // ä¿è­·æ€§åˆä½µï¼šç¢ºä¿æ‰€æœ‰æ¬„ä½å­˜åœ¨
        Object.keys(defaultStructure).forEach(key => {
            if (result[key] === undefined) {
                console.warn(`[normalizeState] ç¼ºå°‘æ¬„ä½ "${key}"ï¼Œå·²è£œä¸Šé è¨­å€¼`);
                result[key] = defaultStructure[key];
            }
        });
        
        // å‹åˆ¥é˜²å‘†ï¼šcharacters/words å¿…é ˆæ˜¯ç´”ç‰©ä»¶ï¼ˆé null/array/stringï¼‰
        if (!result.characters || typeof result.characters !== 'object' || Array.isArray(result.characters)) {
            console.warn('[normalizeState] characters å‹åˆ¥éŒ¯èª¤ï¼Œå·²é‡ç½®ç‚º {}');
            result.characters = {};
        }
        if (!result.words || typeof result.words !== 'object' || Array.isArray(result.words)) {
            console.warn('[normalizeState] words å‹åˆ¥éŒ¯èª¤ï¼Œå·²é‡ç½®ç‚º {}');
            result.words = {};
        }
        
        // é©—è­‰ characters
        const charDefault = { interval: 0, ease: 2.5, reps: 0, nextReview: Date.now(), lastStarDate: null, lastSRSDate: null };
        let fixedCount = 0;
        
        Object.entries(result.characters).forEach(([char, data]) => {
            // entry data å‹åˆ¥é˜²å‘†ï¼šé object å‰‡é‡ç½®
            if (!data || typeof data !== 'object' || Array.isArray(data)) {
                result.characters[char] = { ...charDefault };
                fixedCount++;
                return;
            }
            
            let fixed = false;
            
            // æª¢æŸ¥å¿…è¦æ¬„ä½
            Object.keys(charDefault).forEach(field => {
                if (data[field] === undefined) {
                    data[field] = charDefault[field];
                    fixed = true;
                }
            });
            
            // ç¯„åœé™åˆ¶èˆ‡å‹åˆ¥ä¿®æ­£
            data.interval = clamp(data.interval, 0, 3650);  // æœ€å¤š 10 å¹´
            data.ease = clamp(data.ease, 1.3, 3.5);         // SM-2 å¸¸è¦‹ç¯„åœ
            data.reps = clamp(data.reps, 0, 9999);
            
            // ç¢ºä¿ nextReview æ˜¯æœ‰æ•ˆæ•¸å­—ï¼ˆå…ˆè½‰ Number å†æª¢æŸ¥ï¼Œé¿å…å­—ä¸² timestamp è¢«èª¤åˆ¤ï¼‰
            data.nextReview = Number(data.nextReview);
            if (!Number.isFinite(data.nextReview)) {
                console.warn(`[normalizeState] å­— "${char}" çš„ nextReview ç„¡æ•ˆï¼Œå·²ä¿®æ­£`);
                data.nextReview = Date.now();
                fixed = true;
            }
            
            if (fixed) fixedCount++;
        });
        
        // åŒæ¨£é©—è­‰ words
        Object.entries(result.words).forEach(([word, data]) => {
            // entry data å‹åˆ¥é˜²å‘†
            if (!data || typeof data !== 'object' || Array.isArray(data)) {
                result.words[word] = { ...charDefault };
                return;
            }
            
            Object.keys(charDefault).forEach(field => {
                if (data[field] === undefined) {
                    data[field] = charDefault[field];
                }
            });
            // ç¯„åœé™åˆ¶
            data.interval = clamp(data.interval, 0, 3650);
            data.ease = clamp(data.ease, 1.3, 3.5);
            data.reps = clamp(data.reps, 0, 9999);
            // å…ˆè½‰ Number å†æª¢æŸ¥
            data.nextReview = Number(data.nextReview);
            if (!Number.isFinite(data.nextReview)) {
                data.nextReview = Date.now();
            }
        });
        
        console.log(`[normalizeState] é©—è­‰å®Œæˆã€‚å­—æ•¸: ${Object.keys(result.characters).length}, ä¿®æ­£é …ç›®: ${fixedCount}`);
        
        return result;
    }

    window.onload = function() {
        const saved = localStorage.getItem(APP_ID);
        const seedApplied = localStorage.getItem(SEED_FLAG);
        
        if (!saved) {
            // æ²’è³‡æ–™æ‰ seed
            console.log('[window.onload] localStorage ç„¡è³‡æ–™ï¼Œå¥—ç”¨ SEEDED_STATE...');
            state = normalizeState(SEEDED_STATE);
            save();
            localStorage.setItem(SEED_FLAG, 'true');
            console.log('[window.onload] SEEDED_STATE å·²å¥—ç”¨');
        } else {
            // æœ‰è³‡æ–™å°±ç”¨è³‡æ–™ï¼ˆå¿…è¦æ™‚æ­£è¦åŒ–ï¼‰
            state = normalizeState(JSON.parse(saved));
            save(); // æŠŠè£œé½Šå¾Œçš„ç‹€æ…‹å­˜å›å»
            console.log('[window.onload] æ²¿ç”¨ localStorage è³‡æ–™ï¼ˆå·²æ­£è¦åŒ–ï¼‰');
            // ç¢ºä¿ flag å­˜åœ¨ï¼ˆèˆŠç‰ˆå‡ç´šæ™‚å¯èƒ½æ²’æœ‰ï¼‰
            if (!seedApplied) localStorage.setItem(SEED_FLAG, 'true');
        }
        
        checkStreak();
        render();
        updateStarMeter();
    };

    // ä¿ç•™åŸæœ¬çš„ initDefaultData ä½œç‚ºå‚™ç”¨ï¼ˆä¸å†ä½¿ç”¨ï¼Œä½†ä¸åˆªé™¤ä»¥é˜²è¬ä¸€ï¼‰
    function initDefaultData() {
        const raw = "ä¸Šä¸‹ä¸ä¸Ÿä¹³äº®ä½©ä¾†å€‹å„ªå…¬å†°å†·å‰ªå‹•å»å‹å£åƒå‘€å‘†å“ˆå•Šå–å–µå˜´å››åœ’åœŸåœ°å¤šå¤ªå¥³å§¨å­å­©å®›å°‘å°¿å±±å¸«å¸½å¼Ÿå¿ƒå¿«æ„›æˆ‘æ‰‹æ‰“æ¬æ›¸æœ‹æœ¨æ±æœæ¡ƒæ¡Œæ¨‚æ©˜æ­Œæ°´æ³¨æ´—æ½¤æ¿•ç‚’ç…®ç‰™ç‹—çŒ©çŒ´ç©çƒç”Ÿç”·ç•«ç—…ç™½çš®çœ‰çŸ³ç¬‘ç­†ç­·ç±³ç²‰ç´…ç¶ ç¾Šè€è€³è‚‰è‚šèˆè‰²èŠ’èŠ±è‰è‘¡è—è˜‹è›‡å¼•è±†è±¬è²“è²·èµ·è·³è»Šéé…ªé‹¼éŒ¢é–‹é˜¿é›é›ªé›»é‹é ­é£›é£½é¤…é¤Šé¦¬é«˜é«®é¬†é­šé´¨é¹¿é»ƒé»‘é¼ é¼»èˆ¹é¦™ä¸€ä¸‰äºŒäº”äººå…”å“¥åå¤§å¦¹åª½å°æ˜Ÿæœˆç«ç†Šçˆ¸èœè›‹é†«é–€é£¯";
        const now = Date.now();
        Array.from(raw).forEach(c => state.characters[c] = { interval: 0, ease: 2.5, reps: 0, nextReview: now, lastStarDate: null });
        state.wishes = [{ id: 1, text: "åƒä¸€å€‹å†°æ·‡æ·‹", count: 20 }];
        save();
    }

    function pruneState() {
        if (state.stickers && state.stickers.length > STICKER_MAX) state.stickers = state.stickers.slice(-STICKER_MAX);
        const keys = Object.keys(state.dailyHistory || {});
        if (keys.length > HISTORY_DAYS) {
            const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - HISTORY_DAYS);
            keys.forEach(k => { 
                // ä¸€è‡´åŒ–æ—¥æœŸè§£æï¼Œé¿å…æ™‚å€å•é¡Œ
                if (new Date(k + "T00:00:00") < cutoff) delete state.dailyHistory[k]; 
            });
        }
    }

    function save() { 
        pruneState();
        localStorage.setItem(APP_ID, JSON.stringify(state)); 
    }

    function changeMonth(offset) { currentViewDate.setMonth(currentViewDate.getMonth() + offset); renderCalendar(); }
    function resetCalendarView() { currentViewDate = new Date(); renderCalendar(); }

    function checkStreak() {
        const today = localDateStr();
        const last = state.lastActivityDate;
        
        if (!last) return;
        
        // ç”¨æ—¥æœŸå­—ä¸²æ¯”è¼ƒï¼Œé¿å…æ™‚å€/å¤ä»¤æ™‚é–“å•é¡Œ
        const yesterday = addDays(today, -1);
        
        if (last !== today && last !== yesterday) {
            state.streak = 0;
            save();
        }
    }

    function recordDailyActivity() {
        const today = localDateStr();
        if (state.dailyHistory[today]) return; // ä»Šå¤©å·²è¨˜éŒ„éï¼Œä¸é‡è¤‡è™•ç†

        state.dailyHistory[today] = true;

        const last = state.lastActivityDate;
        const yesterday = addDays(today, -1);

        if (!last) {
            // é¦–æ¬¡æ´»å‹•
            state.streak = 1;
        } else if (last === yesterday) {
            // é€£çºŒï¼šæ˜¨å¤©æœ‰æ´»å‹•
            state.streak = (state.streak || 0) + 1;
        } else if (last === today) {
            // åŒä¸€å¤©ï¼ˆç†è«–ä¸Šä¸æœƒåˆ°é€™ï¼Œå› ç‚ºä¸Šé¢å·² returnï¼‰
            // do nothing
        } else {
            // æ–·æ‰äº†ï¼ˆä¸æ˜¯æ˜¨å¤©ä¹Ÿä¸æ˜¯ä»Šå¤©ï¼‰
            state.streak = 1;
        }

        state.lastActivityDate = today;

        fireConfetti();
        showNotification(`ç¿’æ…£é»äº®ï¼ç²å¾—çš‡å†  ğŸ‘‘`);

        save();
        render();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        const title = document.getElementById('calendar-title');
        if (!grid || !title) return;
        grid.innerHTML = '';
        const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
        const realTodayStr = localDateStr();
        const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
        title.innerText = `${year} ${monthNames[month]}`;
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
            const div = document.createElement('div'); div.className = 'calendar-weekday'; div.innerText = d; grid.appendChild(div);
        });
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) {
            const div = document.createElement('div'); div.className = 'calendar-day empty'; grid.appendChild(div);
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDay = new Date(year, month, day);
            const dateStr = `${currentDay.getFullYear()}-${String(currentDay.getMonth()+1).padStart(2,'0')}-${String(currentDay.getDate()).padStart(2,'0')}`;
            const isToday = dateStr === realTodayStr;
            const isDone = state.dailyHistory[dateStr];
            const div = document.createElement('div');
            div.className = `calendar-day ${isDone ? 'active' : ''} ${isToday ? 'today' : ''}`;
            div.innerHTML = `<span>${day}</span>${isDone ? '<span class="day-icon">ğŸ‘‘</span>' : ''}`;
            grid.appendChild(div);
        }
    }

    // çµ±ä¸€ã€Œsession ä¸‹ä¸€å¼µã€å…¥å£ï¼Œé¿å…è·³å¡æˆ–é‡è¤‡
    function advanceReviewSession() {
        reviewQueue.shift();
        showNextReview();
    }

    function handleSRS(key, rating, isSession) {
        // åªæœ‰ã€Œè¨˜å¾—ä»¥ä¸Šã€æ‰ç®—æ‰“å¡ï¼ˆå¿˜è¨˜ä¸ç®—å®Œæˆç·´ç¿’ï¼‰
        if (rating > 1) recordDailyActivity();
        
        // é˜²å‘†ï¼šæª¢æŸ¥ key æ˜¯å¦å­˜åœ¨
        const pool = state.characters[key] ? state.characters : (state.words[key] ? state.words : null);
        if (!pool) {
            showNotification("è³‡æ–™æ€ªæ€ªçš„ï¼Œæ‰¾ä¸åˆ°é€™å€‹å­—/è©");
            closeModal();
            return;
        }
        
        const item = pool[key] || { interval: 0, ease: 2.5, reps: 0, nextReview: Date.now(), lastStarDate: null, lastSRSDate: null };
        const today = localDateStr();
        const alreadyUpdatedToday = (item.lastSRSDate === today);

        // ===== SRS æ’ç¨‹é‚è¼¯ï¼šåŒæ—¥åªèƒ½è®Šè¿‘ï¼Œä¸èƒ½è®Šé  =====
        if (!alreadyUpdatedToday) {
            // ä»Šå¤©ç¬¬ä¸€æ¬¡ï¼šæ­£å¸¸è·‘ SRS
            const updated = calculateSRS(item, rating);
            pool[key] = updated;
            pool[key].lastSRSDate = today;
        } else {
            // ä»Šå¤©å·²ç¶“æ›´æ–°éæ’ç¨‹ï¼šåªå…è¨±ã€Œå¿˜è¨˜/å›°é›£ã€æ‹‰è¿‘ï¼Œä¸å…è¨±ã€Œè¨˜å¾—/å¤ªç°¡å–®ã€æ¨é 
            if (rating === 1) {
                // å¿˜è¨˜ï¼šå¼·åˆ¶æ˜å¤©å†è¦‹
                item.reps = 0;
                item.interval = 1;
                item.ease = Math.max(1.3, (item.ease || 2.5) - 0.2);
                item.nextReview = Date.now() + 86400000;
            } else if (rating === 2) {
                // å›°é›£ï¼šç¨å¾Œå†çœ‹ï¼ˆä½†æœ‰æœ€å°é–“éš”ï¼Œé¿å…ç«‹å³é‡è¤‡ï¼‰
                const soon = Date.now() + HARD_REVIEW_MS;
                item.nextReview = Math.min(item.nextReview || soon, soon);
                item.nextReview = Math.max(item.nextReview, Date.now() + MIN_REVIEW_GAP_MS);
                item.ease = Math.max(1.3, (item.ease || 2.5) - 0.15);
                
                // Session æ¨¡å¼ï¼šæŠŠé€™å€‹å­—å¡å› queue å°¾ç«¯ï¼Œä»Šå¤©é‚„èƒ½å†ç·´åˆ°
                if (isSession && !reviewQueue.includes(key)) {
                    reviewQueue.push(key);
                }
            }
            // rating 3/4ï¼ˆè¨˜å¾—/å¤ªç°¡å–®ï¼‰ï¼šä¸å‹•æ’ç¨‹ï¼Œé¿å…æ¨é 
            pool[key] = item;
        }

        // ===== æ˜Ÿæ˜Ÿé‚è¼¯ï¼šä¾èˆŠç”¨ lastStarDate æ§åˆ¶ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰=====
        let earnedStar = false;
        if (rating > 1 && pool[key].lastStarDate !== today) {
            state.currentStars = (state.currentStars || 0) + 1;
            pool[key].lastStarDate = today; 
            earnedStar = true;
        }

        // ===== UI å›é¥‹ =====
        if (state.currentStars >= STAR_TARGET) {
            state.currentStars = 0;
            save();
            updateStarMeter(); 
            triggerReward(isSession); 
        } else {
            updateStarMeter(); 
            save(); 
            if (isSession) { advanceReviewSession(); }
            else { closeModal(); render(); }
            
            // é€šçŸ¥è¨Šæ¯ï¼ˆç”¨ã€Œæ˜¯å¦å·²é ˜æ˜Ÿã€äº‹å¯¦åˆ¤æ–·ï¼Œè€Œé SRS æ›´æ–°ç‹€æ…‹ï¼‰
            if (earnedStar) {
                showNotification("æ˜Ÿæ˜Ÿ +1 âœ¨");
            } else if (rating > 1) {
                // æ²’å¾—åˆ°æ˜Ÿ = ä»Šå¤©å·²ç¶“é ˜éé€™å€‹å­—çš„æ˜Ÿäº†
                showNotification("ä»Šå¤©é ˜éæ˜Ÿå›‰ï¼Œå†ç†Ÿæ‚‰ä¸€ä¸‹ï¼ğŸŒ¸");
            } else {
                showNotification("æ²’é—œä¿‚ï¼Œå¤šçœ‹å¹¾æ¬¡å°±æœƒè¨˜ä½å›‰ï¼ğŸ’–");
            }
        }
    }

    function triggerReward(isSessionOrQuiz) {
        fireConfetti();
        const newSticker = STICKER_POOL[Math.floor(Math.random() * STICKER_POOL.length)];
        if(!state.stickers) state.stickers = [];
        state.stickers.push(newSticker);
        save(); 
        const content = document.getElementById('modal-content');
        content.innerHTML = `
            <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <div style="font-size: 70px;">ğŸŒˆ</div>
                <h2 style="color:var(--primary); line-height:1.4;">æ˜Ÿæ˜Ÿé›†æ»¿å›‰ï¼<br>ç²å¾—ä¸€å¼µæ–°è²¼ç´™ï¼</h2>
                <div style="font-size: 110px; animation: bounce 1s infinite; margin: 20px 0;">${newSticker}</div>
            </div>
            <button class="btn btn-primary" style="width:100%; height:55px; border-radius:25px;" onclick="closeRewardAndContinue(${isSessionOrQuiz})">æ”¶ä¸‹è²¼ç´™ï¼Œç¹¼çºŒå†’éšª</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    // çµ±ä¸€æ”¶ä¸‹è²¼ç´™å¾Œçš„é‚è¼¯
    function closeRewardAndContinue(isSession) {
        closeModal();
        if (isSession && reviewQueue.length > 0) {
            advanceReviewSession();
        } else {
            render();
        }
    }

    function checkQuiz(btn, sel, tar) {
        const today = localDateStr();
        let starAwarded = false;
        
        // é–å®šæœ¬é¡Œé¸é …æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¦†é»æ“Šï¼ˆç”¨æ˜ç¢º id æ›´ç©©å®šï¼‰
        const container = document.getElementById('quiz-options');
        const btns = container.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);

        if(sel === tar) { 
            btn.style.backgroundColor="#DFF9FB"; 
            btn.style.borderColor="var(--success)";
            quizData.score++; 
            
            // Quiz ç­”å°ä¹Ÿç®—æ‰“å¡ï¼ˆè¨ˆå…¥ streakï¼‰
            recordDailyActivity();
            
            // ä½¿ç”¨ ensureCharExists ç¢ºä¿å­—å­˜åœ¨ï¼Œç­”å°ä¸€å®šèƒ½ç™¼æ˜Ÿ
            const item = ensureCharExists(tar);
            if (item.lastStarDate !== today) {
                state.currentStars = (state.currentStars || 0) + 1;
                item.lastStarDate = today;
                starAwarded = true;
            }
        } else {
            btn.style.backgroundColor="#FFECEC";
            btn.style.borderColor="var(--danger)";
            // æ•™å­¸å„ªåŒ–ï¼šç­”éŒ¯æ™‚é«˜äº®æ­£ç¢ºç­”æ¡ˆ
            btns.forEach(b => {
                if (b.innerText === tar) {
                    b.style.backgroundColor = "#DFF9FB";
                    b.style.borderColor = "var(--primary)";
                }
            });
        }
        
        save(); 

        if (state.currentStars >= STAR_TARGET) {
            state.currentStars = 0;
            save();
            updateStarMeter();
            setTimeout(() => triggerReward(false), 800); 
        } else {
            const delay = (sel === tar) ? 1000 : 1800; // ç­”éŒ¯ç•™ä¹…ä¸€é»è®“å­©å­çœ‹æ¸…æ¥šæ­£ç¢ºå­—
            setTimeout(() => { 
                if (starAwarded) showNotification("ç­”å°äº†ï¼é­”æ³•æ˜Ÿæ˜Ÿ +1 âœ¨");
                quizData.current++; 
                renderQuizStep(); 
                updateStarMeter(); 
            }, delay);
        }
    }

    function updateStarMeter() {
        const box = document.getElementById('star-box'), needed = document.getElementById('stars-needed');
        if (!box || !needed) return;
        const count = state.currentStars || 0;
        needed.innerText = Math.max(0, STAR_TARGET - count);
        box.innerHTML = Array(STAR_TARGET).fill(0).map((_,i) => `<span style="opacity:${i<count?1:0.2}">${i<count?'â­':'âšª'}</span>`).join('');
        
        // ä¿®æ­£ï¼šé¦–é è²¼ç´™é è¦½åªé¡¯ç¤ºæœ€è¿‘ 8 å¼µï¼Œä¸¦åŠ ä¸Šã€Œæ›´å¤šã€æç¤º
        const preview = document.getElementById('sticker-preview');
        preview.innerHTML = '<span style="font-size: 11px; color: #FF7EB9; font-weight: 700; flex-shrink: 0;">è²¼ç´™ç°¿ï¼š</span>';
        const allStickers = state.stickers || [];
        const displayStickers = allStickers.slice(-8); // åªé¡¯ç¤ºæœ€è¿‘ 8 å¼µ
        displayStickers.forEach(s => {
            const span = document.createElement('span'); 
            span.style.fontSize = "24px"; 
            span.style.flexShrink = "0";
            span.innerText = s; 
            preview.appendChild(span);
        });
        // å¦‚æœæœ‰æ›´å¤šè²¼ç´™ï¼Œé¡¯ç¤ºæ•¸é‡æç¤º
        if (allStickers.length > 8) {
            const more = document.createElement('span');
            more.style.cssText = 'font-size: 10px; color: #A1887F; flex-shrink: 0; margin-left: 4px;';
            more.innerText = `+${allStickers.length - 8}`;
            preview.appendChild(more);
        }
    }

    function calculateSRS(item, rating) {
        let { interval = 0, ease = 2.5, reps = 0, lastStarDate = null, lastSRSDate = null } = item;
        const now = Date.now();
        if (rating === 1) { 
            // å¿˜è¨˜ï¼šæ˜å¤©è¦‹
            reps = 0; 
            interval = 1;
            ease = Math.max(1.3, ease - 0.2); 
        }
        else if (rating === 2) {
            // å›°é›£ï¼šä¿å®ˆè™•ç†ï¼Œinterval ç¶­æŒæˆ–å°å¹…ç¸®çŸ­ï¼ˆä¸è¦æ¨é ï¼‰
            if (reps === 0) interval = 1;
            else interval = Math.max(1, Math.ceil(interval * 0.8)); // ç¸®çŸ­ 20%
            reps++;
            ease = Math.max(1.3, ease - 0.15);
        }
        else {
            // è¨˜å¾—(3) / å¤ªç°¡å–®(4)ï¼šæ­£å¸¸æ¨é€²
            if (reps === 0) interval = (rating === 4) ? 4 : 1;
            else if (reps === 1) interval = 6;
            else interval = Math.ceil(interval * (rating === 4 ? ease * 1.3 : ease));
            reps++;
            if (rating === 4) ease += 0.15;
        }
        return { interval, ease, reps, nextReview: now + (interval * 86400000), lastStarDate, lastSRSDate };
    }

    function render() {
        // æ¯æ¬¡ render æª¢æŸ¥ streakï¼ˆè§£æ±ºé é¢é•·æ™‚é–“é–‹è‘—è·¨æ—¥çš„å•é¡Œï¼‰
        checkStreak();
        
        const chars = Object.entries(state.characters), words = Object.entries(state.words);
        const all = [...chars, ...words], now = Date.now();
        
        // è¨ˆç®—ä¸€æ¬¡å¾…è¤‡ç¿’æ•¸é‡ï¼ˆé¿å…é‡è¤‡æƒæï¼‰
        const dueCount = all.reduce((acc, [,v]) => acc + (v.nextReview <= now ? 1 : 0), 0);
        
        document.getElementById('total-count').innerText = all.length;
        document.getElementById('review-count').innerText = dueCount;
        document.getElementById('streak-count').innerText = state.streak || 0;
        document.getElementById('start-review-btn').className = dueCount > 0 ? 'btn btn-primary btn-review-alert' : 'btn btn-primary';
        
        renderCalendar();
        const bar = document.getElementById('fam-bar'); bar.innerHTML = '';
        [{c:'#FFDAB9',f:v=>v.interval>30},{c:'#E2D5F0',f:v=>v.interval>10&&v.interval<=30},{c:'#FAD0C4',f:v=>v.interval>3&&v.interval<=10},{c:'#FFD1DC',f:v=>v.interval>=0&&v.interval<=3}].forEach(t=>{
            const c = all.filter(([k,v])=>t.f(v)).length;
            const s = document.createElement('div'); s.className='fam-seg'; s.style.width=`${(c/(all.length||1))*100}%`; s.style.backgroundColor=t.c; bar.appendChild(s);
        });
        const container = document.getElementById('main-list'); container.innerHTML = '';
        let list = (currentTab==='review') ? all.filter(([k,v])=>v.nextReview<=now) : (currentTab==='words') ? words : all;
        list.sort((a,b)=>a[1].nextReview-b[1].nextReview).forEach(([k,v])=>{
            const card = document.createElement('div'); card.className='char-card'; card.style.backgroundColor=getCardColor(v.interval);
            card.onclick=()=>openSingleFlashcard(k);
            const d = new Date(v.nextReview || now);
            // ä½¿ç”¨ escapeHtml é˜²æ­¢ XSS
            card.innerHTML=`<div class="char-text" style="font-size:${k.length>4?'12px':(k.length>2?'18px':'28px')}">${escapeHtml(k)}</div><div class="review-date">${d.getMonth()+1}/${d.getDate()}</div>`;
            container.appendChild(card);
        });
    }

    function openSingleFlashcard(k) { renderSRSContent(k, false); document.getElementById('modal-overlay').style.display='flex'; }
    
    function renderSRSContent(k, s) {
        const content = document.getElementById('modal-content'); 
        let fs = k.length===1?'180px':(k.length===2?'130px':(k.length===3?'90px':'70px'));
        const safeK = escapeHtml(k);
        const jsK = JSON.stringify(k);  // å®‰å…¨çš„ JS å­—ä¸²å¸¸å€¼
        content.innerHTML = `
            <button onclick="closeModal()" style="position:absolute;top:20px;right:20px;border:none;background:none;font-size:28px;color:#ccc;">âœ•</button>
            <div class="flashcard-main" style="font-size:${fs}">${safeK}</div>
            <div style="width:100%;">
                <p style="font-size:10px; color:#A1887F; margin-bottom:10px; text-align:center;">å®¶é•·è¨˜éŒ„ç†Ÿæ‚‰åº¦</p>
                <div class="srs-controls">
                    <button class="srs-btn btn-again" onclick="handleSRS(${jsK},1,${s})">å¿˜è¨˜<span>æ˜å¤©è¦‹</span></button>
                    <button class="srs-btn btn-hard" onclick="handleSRS(${jsK},2,${s})">å›°é›£<span>å†çœ‹ä¸€æ¬¡</span></button>
                    <button class="srs-btn btn-good" onclick="handleSRS(${jsK},3,${s})">è¨˜å¾—<span>ç©©æ­¥é•·å¤§</span></button>
                    <button class="srs-btn btn-easy" onclick="handleSRS(${jsK},4,${s})">å¤ªç°¡å–®<span>è·³ç´š</span></button>
                </div>
            </div>`;
    }

    function startReviewSession() {
        reviewQueue = [...Object.entries(state.characters),...Object.entries(state.words)].filter(([k,v])=>v.nextReview<=Date.now()).map(([k,v])=>k).sort(()=>Math.random()-0.5);
        if(reviewQueue.length===0)return showNotification("ğŸ‰ ç›®å‰æ²’å­—è¦è¤‡ç¿’ã€‚");
        showNextReview();
    }

    function showNextReview() { if(reviewQueue.length===0){render();closeModal();return showNotification("ğŸ’– å†’éšªå®Œæˆï¼");} renderSRSContent(reviewQueue[0],true); document.getElementById('modal-overlay').style.display='flex'; }

    function startQuizSession() {
        if(!state.similarPairs || state.similarPairs.length === 0) return showNotification("å…ˆå»è¨­å®šç›¸è¿‘å­—å–”ï¼");
        quizData = { current: 1, total: Math.min(QUIZ_MAX_Q, state.similarPairs.length), score: 0 };
        renderQuizStep(); document.getElementById('modal-overlay').style.display = 'flex';
    }

    function renderQuizStep() {
        if (quizData.current > quizData.total) return renderQuizResult();
        const pair = state.similarPairs[Math.floor(Math.random() * state.similarPairs.length)];
        const target = Math.random() > 0.5 ? pair.c1 : pair.c2;
        const options = [pair.c1, pair.c2].sort(() => Math.random() - 0.5);
        const safeTarget = escapeHtml(target);
        const jsTarget = JSON.stringify(target);
        document.getElementById('modal-content').innerHTML = `
            <div style="position:absolute; top:20px; font-size:14px; color:var(--primary); font-weight:700;">âœ¨ ç¬¬ ${quizData.current} / ${quizData.total} é¡Œ âœ¨</div>
            <div style="margin-top:40px;">æ‰¾åˆ°é€™å€‹å­—ï¼š</div><div class="flashcard-main" style="font-size:130px;margin:20px 0;">${safeTarget}</div>
            <div id="quiz-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; width:100%;">${options.map(o=>`<button class="btn btn-outline" style="font-size:65px; padding:25px; border-radius:30px; height:140px; font-weight:700;" onclick="checkQuiz(this,${JSON.stringify(o)},${jsTarget})">${escapeHtml(o)}</button>`).join('')}</div>`;
    }

    function renderQuizResult() { fireConfetti(); document.getElementById('modal-content').innerHTML = `<div class="flashcard-main" style="flex-direction:column; font-size:24px;"><h2 style="color:var(--primary);">ğŸŠ æŒ‘æˆ°å®Œæˆï¼</h2><div style="font-size:80px; margin: 20px 0;">ğŸ†</div><div style="font-weight:700;">å¦³ç­”å°äº† ${quizData.score} é¡Œï¼</div></div><button class="btn btn-primary" style="width:100%; height:55px; border-radius:25px;" onclick="closeModal()">å›ä¸»é çœ‹æœˆæ›†</button>`; save(); }

    function openParentalGuide() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<button onclick="closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc;">âœ•</button><h2 style="color:var(--primary);">ğŸ“– å®¶é•·å°èˆªèªªæ˜æ›¸</h2><div class="guide-section"><h3>ğŸ”’ å…¬å¹³çå‹µæ©Ÿåˆ¶</h3><p><strong>æ¯å€‹å­—æ¯å¤©ä¸è«–æ¨¡å¼åªèƒ½é ˜ä¸€æ¬¡æ˜Ÿæ˜Ÿ</strong>ã€‚é€™èƒ½ç¢ºä¿çå‹µçš„çè²´æ€§ï¼Œä¸¦é˜²æ­¢å­©å­é‡è¤‡åˆ·åˆ†ã€‚</p><h3>ğŸ“… å†’éšªæœˆæ›†</h3><p>ğŸ‘‘ ä»£è¡¨ç•¶å¤©æœ‰ç·´ç¿’ã€‚å»ºè­°èˆ‡å­©å­ç´„å®šé›†æ»¿æ•´å€‹æœˆçš„ç¾å¯¦çå‹µã€‚</p><h3>ğŸ§  è¨˜æ†¶ç§‘å­¸</h3><p>ç³»çµ±è‡ªå‹•è¨ˆç®—è¤‡ç¿’å¤©æ•¸ï¼Œè³‡æ–™ä¹Ÿæœƒè‡ªå‹•ç˜¦èº«ï¼ˆä¿ç•™æœ€è¿‘365å¤©ï¼‰ä»¥ç¶­æŒç³»çµ±æµæš¢ã€‚</p><h3>ğŸ¯ è¾¨è­˜å¤§æŒ‘æˆ°</h3><p>ç­”å°çš„ç›¸è¿‘å­—æœƒè‡ªå‹•åŠ å…¥å­—åº«ï¼Œæ–¹ä¾¿å¾ŒçºŒè¤‡ç¿’è¿½è¹¤ã€‚</p></div><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="closeModal()">äº†è§£äº†</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openSimilarManager() {
        const listHtml = (state.similarPairs || []).map(p => `<div style="display:flex; justify-content:space-between; align-items:center; width:100%; padding:10px; border-bottom:1px solid #FFF0F5;"><span style="font-size:22px; font-weight:700;">${escapeHtml(p.c1)} â†” ${escapeHtml(p.c2)}</span><button onclick="removePair(${JSON.stringify(p.id)})" style="color:var(--danger); border:none; background:none; font-size:18px;">ğŸ—‘ï¸</button></div>`).join('');
        document.getElementById('modal-content').innerHTML = `<button onclick="closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc;">âœ•</button><h2 style="color:var(--primary); margin-bottom:15px;">âš™ï¸ ç›¸è¿‘å­—ç®¡ç†</h2><div style="background:#FFF0F5; padding:20px; border-radius:24px; width:100%; margin-bottom:20px;"><div style="display:flex; gap:10px; justify-content:center;"><input type="text" id="sim-c1" maxlength="1" placeholder="å­—" style="width:60px; text-align:center; padding:10px; border:2px solid #FFD1DC; border-radius:12px; font-size:20px; font-weight:700;"><input type="text" id="sim-c2" maxlength="1" placeholder="å­—" style="width:60px; text-align:center; padding:10px; border:2px solid #FFD1DC; border-radius:12px; font-size:20px; font-weight:700;"><button class="btn btn-primary" onclick="addPair()">æ–°å¢</button></div></div><div style="width:100%;">${listHtml || '<p style="text-align:center; color:#ccc;">è¨­å®šå®¹æ˜“æ··æ·†çš„å­—çµ„</p>'}</div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function addPair() {
        const c1 = document.getElementById('sim-c1').value.trim(), c2 = document.getElementById('sim-c2').value.trim();
        if(!c1 || !c2 || c1 === c2) return;
        
        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå«äº’æ›é †åºï¼‰
        const exists = (state.similarPairs || []).some(p => 
            (p.c1 === c1 && p.c2 === c2) || (p.c1 === c2 && p.c2 === c1)
        );
        if (exists) {
            return showNotification('é€™çµ„ç›¸è¿‘å­—å·²ç¶“å­˜åœ¨å›‰ï½');
        }
        
        state.similarPairs.push({id: Date.now(), c1, c2}); 
        save(); 
        openSimilarManager(); 
        render();
    }
    function removePair(id){ state.similarPairs = state.similarPairs.filter(p=>p.id!==id); save(); openSimilarManager(); render(); }
    
    // è²¼ç´™ç‰†é¡¯ç¤ºç‹€æ…‹ï¼ˆç”¨æ–¼åˆ†æ‰¹è¼‰å…¥ï¼‰
    let stickerWallShowAll = false;
    
    // ä¿®æ­£ï¼šè²¼ç´™ç‰†ä½¿ç”¨æ–°çš„ä½ˆå±€çµæ§‹ + åˆ†æ‰¹é¡¯ç¤ºé¿å…å¡é “
    function openStickerWall() {
        const allStickers = state.stickers || [];
        const count = allStickers.length;
        const STICKER_PREVIEW_LIMIT = 60;
        
        // åˆ†æ‰¹é¡¯ç¤ºï¼šé è¨­åªé¡¯ç¤ºæœ€è¿‘ 60 å¼µ
        const displayStickers = stickerWallShowAll ? allStickers : allStickers.slice(-STICKER_PREVIEW_LIMIT);
        const hasMore = !stickerWallShowAll && count > STICKER_PREVIEW_LIMIT;
        
        const stickerHtml = displayStickers.map(s => `<div style="font-size:48px; cursor:pointer; transition: transform 0.2s;" onclick="this.style.transform='scale(1.5)';setTimeout(()=>this.style.transform='scale(1)',300)">${escapeHtml(s)}</div>`).join('');
        const showMoreBtn = hasMore ? `<div style="grid-column:span 4; text-align:center; padding:10px;"><button class="btn btn-outline" onclick="stickerWallShowAll=true;openStickerWall();" style="font-size:12px; padding:8px 16px;">é¡¯ç¤ºå…¨éƒ¨ ${count} å¼µ</button></div>` : '';
        
        const wishesHtml = (state.wishes || []).map(w => {
            const pct = Math.min(100, (count / w.count) * 100);
            const safeText = escapeHtml(w.text);
            return `<div class="wish-item"><div class="wish-header"><span>ğŸ ${safeText}</span><span>${count} / ${w.count}</span></div><div class="wish-progress-bg"><div class="wish-progress-fill" style="width:${pct}%"></div></div><button onclick="removeWish(${JSON.stringify(w.id)})" style="background:none; border:none; color:#ccc; font-size:10px; margin-top:5px;">ğŸ—‘ï¸ ç§»é™¤</button></div>`;
        }).join('');
        
        document.getElementById('modal-content').innerHTML = `
            <button onclick="stickerWallShowAll=false;closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc; z-index:10;">âœ•</button>
            <div class="sticker-wall-container">
                <div class="sticker-wall-header">
                    <h2 style="color:var(--primary); margin: 10px 0 5px 0;">âœ¨ å¦¹å¦¹çš„å¤¢å¹»è²¼ç´™ç‰† âœ¨</h2>
                    <div style="font-size:12px; color:#8d6e63;">å¦³ç¸½å…±æ”¶é›†äº† <strong style="color:var(--primary); font-size:16px;">${count}</strong> å¼µè²¼ç´™ï¼</div>
                </div>
                
                <div class="sticker-grid-wrapper">
                    <div class="sticker-grid">
                        ${stickerHtml || '<p style="grid-column:span 4; color:#ccc; text-align:center;">è¶•å¿«å†’éšªæ”¶é›†è²¼ç´™å§</p>'}
                        ${showMoreBtn}
                    </div>
                </div>
                
                <div class="wish-section">
                    <h3 style="font-size:14px; color:var(--primary); margin: 0 0 15px 0; text-align:center;">ğŸŒŸ é­”æ³•é¡˜æœ›æ¸…å–®</h3>
                    ${wishesHtml}
                    <div style="margin-top:15px; border-top:1px dashed #FFD1DC; padding-top:15px;">
                        <input type="text" id="new-wish-text" placeholder="è¼¸å…¥é¡˜æœ›..." style="width:100%; padding:8px; border:1px solid #FFD1DC; border-radius:10px; margin-bottom:8px; font-size:12px;">
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="new-wish-count" placeholder="éœ€å¹¾å¼µ?" style="width:60%; padding:8px; border:1px solid #FFD1DC; border-radius:10px; font-size:12px;">
                            <button class="btn btn-primary" onclick="addWish()" style="flex:1;">â•</button>
                        </div>
                    </div>
                </div>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function addWish() {
        const text = document.getElementById('new-wish-text').value.trim();
        const count = Number(document.getElementById('new-wish-count').value);
        
        if (!text) {
            return showNotification('è«‹è¼¸å…¥é¡˜æœ›å…§å®¹å–”ï½');
        }
        if (!Number.isFinite(count) || count <= 0 || !Number.isInteger(count)) {
            return showNotification('è«‹è¼¸å…¥æ­£ç¢ºçš„å¼µæ•¸ï¼ˆæ­£æ•´æ•¸ï¼‰');
        }
        
        if(!state.wishes) state.wishes = [];
        state.wishes.push({ id: Date.now(), text, count });
        save(); openStickerWall();
    }

    function removeWish(id) {
        state.wishes = (state.wishes || []).filter(w => w.id !== id);
        save(); openStickerWall();
    }

    function quickAdd(t) {
        const i = document.getElementById(t==='char'?'add-char-input':'add-word-input');
        let v = i.value.trim(); 
        if(!v) return;
        
        const now = Date.now(); 
        if(t==='char') {
            // æ¸…æ´—è¼¸å…¥ï¼šå»æ‰ã€Œã€ã€ã€Œ,ã€ã€Œï¼Œã€ç­‰åˆ†éš”ç¬¦
            v = normalizeInputChars(v);
            if(!v) return;
            Array.from(v).forEach(c => {
                // åªåŠ å…¥ä¸­æ–‡å­—ï¼ˆæ“´å±•åˆ° \u9fff æ›´å®Œæ•´ï¼‰
                if(/[\u4e00-\u9fff]/.test(c) && !state.characters[c]) {
                    state.characters[c] = {interval:0, ease:2.5, reps:0, nextReview:now, lastStarDate:null, lastSRSDate:null};
                }
            });
        } else { 
            // è©èªè‡³å°‘è¦åŒ…å«ä¸€å€‹ä¸­æ–‡å­—
            if (!/[\u4e00-\u9fff]/.test(v)) {
                return showNotification('è«‹è¼¸å…¥ä¸­æ–‡è©èªå–”ï½');
            }
            // ä¸è¦†è“‹å·²å­˜åœ¨çš„è©ï¼ˆä¿è­·å­¸ç¿’é€²åº¦ï¼‰
            if (state.words[v]) {
                i.value='';
                return showNotification('é€™å€‹è©å·²ç¶“åœ¨è©åº«å›‰ï½');
            }
            state.words[v] = {interval:0, ease:2.5, reps:0, nextReview:now, lastStarDate:null, lastSRSDate:null}; 
            Array.from(v).forEach(c => {
                if(!state.characters[c] && /[\u4e00-\u9fff]/.test(c)) {
                    state.characters[c] = {interval:0, ease:2.5, reps:0, nextReview:now, lastStarDate:null, lastSRSDate:null};
                }
            });
        }
        i.value=''; save(); render(); showNotification('å¤¥ä¼´åŠ å…¥å›‰ï¼');
    }

    function setTab(t, e) { currentTab=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); e.classList.add('active'); render(); }
    function closeModal(){document.getElementById('modal-overlay').style.display='none';}
    function showNotification(m){const d=document.createElement('div');d.className='notification';d.innerText=m;document.getElementById('notification-container').appendChild(d);setTimeout(()=>d.remove(),2000);}
    function exportData(){const a=document.createElement('a');a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state));a.download=`å¦¹å¦¹èªå­—_${localDateStr()}.json`;a.click();}
    function importData(event){
        const f=event.target.files[0];if(!f)return;
        const r=new FileReader();
        r.onload=e=>{
            try{
                const d=JSON.parse(e.target.result);
                const defaultState = {
                    characters: {}, words: {}, similarPairs: [], stickers: [], currentStars: 0,
                    streak: 0, lastActivityDate: null, dailyHistory: {}, wishes: []
                };
                
                if(d.learners&&d.learners.sister){
                    // èˆŠæ ¼å¼ï¼šlearners/sister çµæ§‹
                    const sis=d.learners.sister.data.characters;
                    let imported = { ...defaultState, characters: {}, words: {} };
                    
                    Object.entries(sis).forEach(([k,v])=>{
                        const i = (v.level===4?60:v.level===3?14:v.level===2?7:v.level===1?3:0); 
                        imported.characters[k] = {
                            interval: i,
                            ease: 2.5,
                            reps: v.level || 0,
                            nextReview: v.nextReview || Date.now(),
                            lastStarDate: null
                        };
                    });
                    
                    state = normalizeState(imported);
                } else {
                    // æ–°æ ¼å¼ï¼šç›´æ¥åŒ¯å…¥ï¼ˆç”¨ normalizeState è£œé½Šæ‰€æœ‰æ¬„ä½ï¼‰
                    state = normalizeState({ ...defaultState, ...d });
                }
                
                save();render();updateStarMeter();showNotification('è¼‰å…¥æˆåŠŸï¼');
            }catch(x){console.error(x);showNotification('è¼‰å…¥éŒ¯èª¤');}
        };
        r.readAsText(f);
    }
</script>
</body>
</html>
