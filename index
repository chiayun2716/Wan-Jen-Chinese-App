<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¦¹å¦¹ä¸­æ–‡å­¸ç¿’è¨˜éŒ„å™¨ - é­”æ³•å¤§å¸«æœ€çµ‚ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF7EB9; /* è‰è“ç²‰ */
            --primary-dark: #FF5A9D;
            --secondary: #B983FF; /* æŸ”å’Œç´« */
            --bg-gradient: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%);
            --white: #ffffff;
            --text: #5D4037;
            --danger: #FF6B6B;  /* å¿˜è¨˜ - ç´… */
            --warning: #FF9F43; /* å›°é›£ - æ©˜ */
            --info: #48DBFB;    /* è¨˜å¾— - è— */
            --success: #7ED957;  /* å¤ªç°¡å–® - ç¶  */
            --gold: #FFD700;
            
            /* Familiarity Tier Colors */
            --color-new: #ffffff;      
            --color-learning: #FFD1DC; 
            --color-review: #FAD0C4;   
            --color-mastered: #E2D5F0; 
            --color-mature: #FFDAB9;   
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            margin: 0; padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; }

        /* éš±è—å…ƒä»¶ä¿®å¾© */
        .hidden { display: none; }

        /* å¤§æ¨™é¡Œå€ */
        .app-header { text-align: center; margin-bottom: 15px; padding-top: 10px; }
        .app-title {
            font-size: 26px; font-weight: 800; color: var(--primary);
            margin: 0; text-shadow: 2px 2px 0px white;
        }

        /* Stats Card */
        .stats-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 28px; padding: 15px;
            box-shadow: 0 10px 30px rgba(255, 126, 185, 0.15);
            margin-bottom: 12px; border: 2.5px solid #FFD1DC; text-align: center;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--primary); font-family: 'Fredoka'; }
        .stat-label { font-size: 11px; color: #8d6e63; font-weight: 600; }
        .streak-fire { color: #FF4D6D; animation: fire-pulse 1.5s infinite; }
        
        @keyframes fire-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .familiarity-bar { height: 10px; background: #eee; border-radius: 10px; display: flex; overflow: hidden; margin-top: 10px; border: 1px solid #fff; }
        .fam-seg { height: 100%; transition: width 0.6s ease; }

        /* Dashboard Layout */
        .dashboard-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: stretch; }

        /* Monthly Calendar */
        .calendar-section {
            background: white; border-radius: 24px; padding: 12px;
            border: 2px solid #FFD1DC; box-shadow: 0 4px 15px rgba(255, 126, 185, 0.05);
            flex: 1.2; min-width: 300px;
        }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .calendar-nav { display: flex; align-items: center; gap: 8px; }
        .nav-btn { background: none; border: none; font-size: 16px; color: var(--primary); cursor: pointer; padding: 2px; }
        .calendar-title { font-size: 13px; font-weight: 700; color: var(--primary); cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-weekday { font-size: 9px; color: #A1887F; text-align: center; font-weight: bold; padding-bottom: 4px; }
        .calendar-day {
            aspect-ratio: 1; border-radius: 8px; border: 1px solid #FFFafb;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: #ddd; background: #fafafa; position: relative;
            font-family: 'Fredoka', sans-serif;
        }
        .calendar-day.active { background: var(--color-learning); border-color: var(--primary); }
        .calendar-day.today { border: 1.5px solid var(--secondary); color: var(--secondary); font-weight: 900; }
        .calendar-day .day-icon { 
            font-size: 26px; position: absolute; z-index: 2; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        .calendar-day span:not(.day-icon) { z-index: 1; opacity: 0.3; }
        .calendar-day.empty { background: transparent; border: none; }

        /* Reward Area */
        .reward-area {
            background: white; border-radius: 24px; padding: 15px;
            border: 2px solid #FFD1DC; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 126, 185, 0.05);
            flex: 1; min-width: 300px; display: flex; flex-direction: column; justify-content: center;
        }
        .sticker-preview { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; min-height: 50px; align-items: center; }
        .star-meter-container { display: flex; flex-direction: column; align-items: center; gap: 6px; padding-top: 12px; border-top: 1.5px dashed #FFF0F5; }
        .star-box { font-size: 16px; color: var(--gold); display: flex; gap: 1px; }

        /* Actions */
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .btn {
            border: none; border-radius: 18px; padding: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: white; border: 1.5px solid #FFD1DC; color: var(--primary); }
        .btn-review-alert { background: #FF4D6D; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Input Section */
        .input-section { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .input-box { background: white; padding: 10px; border-radius: 20px; border: 2px solid #FFD1DC; }
        .input-box input { width: 100%; border: none; padding: 8px; font-size: 14px; outline: none; background: #fffafb; border-radius: 12px; margin-bottom: 8px; }

        /* Grid */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; }
        .char-card {
            background: white; border-radius: 22px; padding: 12px 5px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer;
            aspect-ratio: 1/1.2; display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.3s;
        }
        .char-text { font-weight: 700; color: #4E342E; width: 95%; word-break: break-all; line-height: 1.2; margin-bottom: 4px; }
        .review-date { font-size: 8px; color: #A1887F; font-family: 'Fredoka'; opacity: 0.8; }

        /* Modal Layout */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 240, 245, 0.98); display: none;
            align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(15px);
        }
        .modal-content {
            background: white; border-radius: 40px; width: 95%; max-width: 550px;
            min-height: 550px; padding: 30px 20px; position: relative;
            box-shadow: 0 20px 60px rgba(255, 126, 185, 0.25); border: 5px solid var(--primary);
            display: flex; flex-direction: column; align-items: center; overflow-y: auto; max-height: 90vh;
        }
        .flashcard-main { font-weight: 700; color: var(--text); text-shadow: 6px 6px 0px #FFD1DC; flex-grow: 1; display: flex; align-items: center; justify-content: center; line-height: 1.1; text-align: center; width: 100%; }

        .srs-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; margin-top: 15px; padding-top: 15px; border-top: 1.5px solid #FFF0F5; }
        .srs-btn { border: none; padding: 12px 2px; border-radius: 16px; font-weight: 700; cursor: pointer; color: white; font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .srs-btn span { font-size: 8px; font-weight: 400; opacity: 0.9; }
        .btn-again { background: var(--danger); } .btn-hard { background: var(--warning); } .btn-good { background: var(--info); } .btn-easy { background: var(--success); }

        .guide-section { text-align: left; width: 100%; color: #5D4037; padding-bottom: 20px; }
        .guide-section h3 { color: var(--primary); border-left: 5px solid var(--primary); padding-left: 12px; margin: 24px 0 12px 0; font-size: 16px; }
        .guide-section p { font-size: 13.5px; line-height: 1.7; background: #fffafa; padding: 12px; border-radius: 15px; border: 1px solid #FFF0F5; }
        .logic-tag { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; margin: 3px; font-weight: bold; background: white; border: 1px solid #ddd; }
        
        .wish-item { background: #fff; border: 1px solid #FFD1DC; border-radius: 15px; padding: 12px; margin-bottom: 10px; width: 100%; }
        .wish-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; color: #5D4037; margin-bottom: 5px; }
        .wish-progress-bg { height: 10px; background: #eee; border-radius: 10px; overflow: hidden; }
        .wish-progress-fill { height: 100%; background: var(--primary); transition: width 1s ease; }

        .confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 5px; }
        .tab { padding: 8px 16px; border-radius: 20px; background: white; border: 1.5px solid #FFD1DC; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; background: var(--text); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; }

        @media (max-width: 768px) {
            .dashboard-row { flex-direction: column; }
            .input-section { grid-template-columns: 1fr; }
            .items-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1 class="app-title">ğŸŒ¸ å¦¹å¦¹çš„èªå­—å†’éšª</h1>
    </div>

    <!-- Stats Header -->
    <div class="stats-card">
        <div class="stats-grid">
            <div class="stat-item"><span class="stat-value en-num" id="total-count">0</span><span class="stat-label">æŒ‘æˆ°ç¸½æ•¸</span></div>
            <div class="stat-item"><span class="stat-value en-num" id="review-count">0</span><span class="stat-label">å¾…è¤‡ç¿’</span></div>
            <div class="stat-item"><span class="stat-value en-num streak-fire" id="streak-count">0</span><span class="stat-label">é€£å‹å¤©æ•¸</span></div>
        </div>
        <div class="familiarity-bar" id="fam-bar"></div>
    </div>

    <!-- Dashboard: Calendar & Rewards -->
    <div class="dashboard-row">
        <div class="calendar-section" id="adventure-calendar">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="changeMonth(-1)">â®</button>
                    <div class="calendar-title" id="calendar-title" onclick="resetCalendarView()">å†’éšªæœˆæ›†</div>
                    <button class="nav-btn" onclick="changeMonth(1)">â¯</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>

        <div class="reward-area" onclick="openStickerWall()">
            <div class="sticker-preview" id="sticker-preview">
                <span style="font-size: 12px; color: #FF7EB9; font-weight: 700;">è²¼ç´™ç°¿ï¼š</span>
            </div>
            <div class="star-meter-container">
                <span style="font-size: 10px; color: #8d6e63;">å†å¾— <strong id="stars-needed" style="color:var(--primary)">10</strong> é¡†æ˜Ÿå°±æœ‰è²¼ç´™ï¼</span>
                <div class="star-box" id="star-box"></div>
            </div>
        </div>
    </div>

    <div class="action-grid">
        <button class="btn btn-primary" onclick="startReviewSession()" id="start-review-btn">âœ¨ é–‹å§‹å†’éšªè¤‡ç¿’</button>
        <button class="btn btn-secondary" onclick="startQuizSession()" id="start-quiz-btn">ğŸ¯ è¾¨è­˜å¤§æŒ‘æˆ°</button>
        <button class="btn btn-outline" onclick="openParentalGuide()">ğŸ“– å®¶é•·èªªæ˜</button>
        <button class="btn btn-outline" onclick="openSimilarManager()">âš™ï¸ ç›¸è¿‘å­—ç®¡ç†</button>
    </div>

    <div class="input-section">
        <div class="input-box">
            <span style="font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 5px; display: block;">ğŸ“– åŠ å…¥å–®å­—</span>
            <input type="text" id="add-char-input" placeholder="å¤©ã€åœ°">
            <button class="btn btn-primary" style="width:100%; padding: 8px;" onclick="quickAdd('char')">åŠ å…¥å­—åº«</button>
        </div>
        <div class="input-box">
            <span style="font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 5px; display: block;">ğŸˆ åŠ å…¥è©èª</span>
            <input type="text" id="add-word-input" placeholder="å¤ªé™½ã€è´è¶">
            <button class="btn btn-primary" style="width:100%; padding: 8px; background:var(--secondary);" onclick="quickAdd('word')">åŠ å…¥è©åº«</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('all', this)">å…¨éƒ¨æ¸…å–®</div>
        <div class="tab" onclick="setTab('review', this)">ä»Šå¤©è¦è®€</div>
        <div class="tab" onclick="setTab('words', this)">åªçœ‹è©èª</div>
    </div>

    <div class="items-grid" id="main-list"></div>

    <div style="margin-top: 40px; text-align: center; opacity: 0.3;">
        <button onclick="exportData()" style="background:none; border:1px solid #ccc; font-size:10px; padding:6px 12px; border-radius:8px;">ğŸ“¥ å‚™ä»½é€²åº¦</button>
        <button onclick="document.getElementById('import-input').click()" style="background:none; border:1px solid #ccc; font-size:10px; padding:6px 12px; border-radius:8px;">ğŸ“¤ è¼‰å…¥ç´€éŒ„</button>
        <input type="file" id="import-input" class="hidden" accept=".json" onchange="importData(event)">
    </div>
</div>

<canvas id="confetti" class="confetti-canvas"></canvas>
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content" id="modal-content"></div>
</div>
<div id="notification-container"></div>

<script>
    // --- Global Helpers ---
    function getCardColor(i) {
        if (i > 30) return 'var(--color-mature)';
        if (i > 10) return 'var(--color-mastered)';
        if (i > 3) return 'var(--color-review)';
        if (i > 0) return 'var(--color-learning)';
        return 'var(--color-new)';
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = Array.from({length: 120}, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * 100,
            color: `hsl(${Math.random() * 360}, 100%, 75%)`,
            tilt: Math.random() * 10 - 10
        }));
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color;
                ctx.moveTo(p.x + p.tilt + p.r / 2, p.y);
                ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 2);
                ctx.stroke();
                p.y += Math.cos(p.d) + 1 + p.r / 2;
                p.x += Math.sin(p.d) * 2;
                if (p.y > canvas.height) { p.y = -20; p.x = Math.random() * canvas.width; }
            });
        }
        let frame = 0;
        const anim = setInterval(() => { 
            draw(); frame++; 
            if (frame > 200) { 
                clearInterval(anim); 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            } 
        }, 20);
    }

    // --- Data State ---
    const APP_ID = 'sister-chinese-magic-master-stable';
    let state = {
        characters: {}, words: {}, similarPairs: [], stickers: [], currentStars: 0,
        streak: 0, lastActivityDate: null, dailyHistory: {}, wishes: []
    };
    
    let currentViewDate = new Date();
    let currentTab = 'all', reviewQueue = [];
    let quizData = { current: 0, total: 0, score: 0 };
    const STICKER_POOL = ["ğŸ¦„", "ğŸ‘¸", "ğŸ­", "ğŸ¡", "åŸå ¡", "ğŸ°", "ğŸ§œâ€â™€ï¸", "ğŸ§š", "ğŸ¦‹", "ğŸŒˆ", "ğŸ§", "ğŸ€", "ğŸ±", "ğŸ°", "ğŸ©°", "ğŸ’", "ğŸ“", "ğŸŒ¸", "â­", "ğŸŒ™", "ğŸ¦‰", "ğŸ¨", "ğŸ¦", "ğŸˆ", "ğŸ‘’"];

    window.onload = function() {
        const saved = localStorage.getItem(APP_ID);
        if (saved) state = JSON.parse(saved);
        else initDefaultData();
        checkStreak();
        render();
        updateStarMeter();
    };

    function initDefaultData() {
        const raw = "ä¸Šä¸‹ä¸ä¸Ÿä¹³äº®ä½©ä¾†å€‹å„ªå…¬å†°å†·å‰ªå‹•å»å‹å£åƒå‘€å‘†å“ˆå•Šå–å–µå˜´å››åœ’åœŸåœ°å¤šå¤ªå¥³å§¨å­å­©å®›å°‘å°¿å±±å¸«å¸½å¼Ÿå¿ƒå¿«æ„›æˆ‘æ‰‹æ‰“æ¬æ›¸æœ‹æœ¨æ±æœæ¡ƒæ¡Œæ¨‚æ©˜æ­Œæ°´æ³¨æ´—æ½¤æ¿•ç‚’ç…®ç‰™ç‹—çŒ©çŒ´ç©çƒç”Ÿç”·ç•«ç—…ç™½çš®çœ‰çŸ³ç¬‘ç­†ç­·ç±³ç²‰ç´…ç¶ ç¾Šè€è€³è‚‰è‚šèˆè‰²èŠ’èŠ±è‰è‘¡è—è˜‹è›‡å¼•è±†è±¬è²“è²·èµ·è·³è»Šéé…ªé‹¼éŒ¢é–‹é˜¿é›é›ªé›»é‹é ­é£›é£½é¤…é¤Šé¦¬é«˜é«®é¬†é­šé´¨é¹¿é»ƒé»‘é¼ é¼»èˆ¹é¦™ä¸€ä¸‰äºŒäº”äººå…”å“¥åå¤§å¦¹åª½å°æ˜Ÿæœˆç«ç†Šçˆ¸èœè›‹é†«é–€é£¯";
        const now = Date.now();
        Array.from(raw).forEach(c => state.characters[c] = { interval: 0, ease: 2.5, reps: 0, nextReview: now, lastStarDate: null });
        state.wishes = [{ id: 1, text: "åƒä¸€å€‹å†°æ·‡æ·‹", count: 20 }];
        save();
    }

    function pruneState() {
        if (state.stickers && state.stickers.length > 200) state.stickers = state.stickers.slice(-200);
        const keys = Object.keys(state.dailyHistory);
        if (keys.length > 365) {
            const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 365);
            keys.forEach(k => { if (new Date(k) < cutoff) delete state.dailyHistory[k]; });
        }
    }

    function save() { 
        pruneState();
        localStorage.setItem(APP_ID, JSON.stringify(state)); 
    }

    function changeMonth(offset) { currentViewDate.setMonth(currentViewDate.getMonth() + offset); renderCalendar(); }
    function resetCalendarView() { currentViewDate = new Date(); renderCalendar(); }

    function checkStreak() {
        const today = new Date().toISOString().split('T')[0];
        if (state.lastActivityDate && state.lastActivityDate !== today) {
            const last = new Date(state.lastActivityDate);
            const current = new Date(today);
            const diffDays = Math.ceil((current - last) / (86400000));
            if (diffDays > 1) state.streak = 0;
        }
    }

    function recordDailyActivity() {
        const today = new Date().toISOString().split('T')[0];
        if (!state.dailyHistory[today]) {
            state.dailyHistory[today] = true;
            if (state.lastActivityDate !== today) {
                state.streak = (state.streak || 0) + 1;
                state.lastActivityDate = today;
                fireConfetti();
                showNotification(`ç¿’æ…£é»äº®ï¼ç²å¾—çš‡å†  ğŸ‘‘`);
            }
            save();
            render();
        }
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        const title = document.getElementById('calendar-title');
        if (!grid || !title) return;
        grid.innerHTML = '';
        const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
        const realTodayStr = new Date().toISOString().split('T')[0];
        const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
        title.innerText = `${year} ${monthNames[month]}`;
        ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
            const div = document.createElement('div'); div.className = 'calendar-weekday'; div.innerText = d; grid.appendChild(div);
        });
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) {
            const div = document.createElement('div'); div.className = 'calendar-day empty'; grid.appendChild(div);
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDay = new Date(year, month, day);
            const dateStr = `${currentDay.getFullYear()}-${String(currentDay.getMonth()+1).padStart(2,'0')}-${String(currentDay.getDate()).padStart(2,'0')}`;
            const isToday = dateStr === realTodayStr;
            const isDone = state.dailyHistory[dateStr];
            const div = document.createElement('div');
            div.className = `calendar-day ${isDone ? 'active' : ''} ${isToday ? 'today' : ''}`;
            div.innerHTML = `<span>${day}</span>${isDone ? '<span class="day-icon">ğŸ‘‘</span>' : ''}`;
            grid.appendChild(div);
        }
    }

    function handleSRS(key, rating, isSession) {
        recordDailyActivity();
        const pool = state.characters[key] ? state.characters : state.words;
        const item = pool[key];
        const today = new Date().toISOString().split('T')[0];

        const updated = calculateSRS(item, rating);
        pool[key] = updated;

        let earnedStar = false;
        // å®‰å…¨å„ªåŒ–ï¼šä½¿ç”¨æ˜ç¢ºçš„è·¯å¾‘è³¦å€¼èˆ‡æª¢æŸ¥
        if (rating > 1 && pool[key].lastStarDate !== today) {
            state.currentStars = (state.currentStars || 0) + 1;
            pool[key].lastStarDate = today; 
            earnedStar = true;
        }

        if (state.currentStars >= 10) {
            state.currentStars = 0;
            save();
            updateStarMeter(); 
            triggerReward(isSession); 
        } else {
            updateStarMeter(); 
            save(); 
            if (isSession) { reviewQueue.shift(); showNextReview(); }
            else { closeModal(); render(); }
            if (earnedStar) showNotification("æ˜Ÿæ˜Ÿ +1 âœ¨");
            else if (rating > 1) showNotification("ä»Šå¤©é ˜éæ˜Ÿå›‰ ğŸŒ¸");
            else showNotification("æ²’é—œä¿‚ï¼Œå¤šçœ‹å¹¾æ¬¡å°±æœƒè¨˜ä½å›‰ï¼ğŸ’–");
        }
    }

    function triggerReward(isSessionOrQuiz) {
        fireConfetti();
        const newSticker = STICKER_POOL[Math.floor(Math.random() * STICKER_POOL.length)];
        if(!state.stickers) state.stickers = [];
        state.stickers.push(newSticker);
        save(); 
        const content = document.getElementById('modal-content');
        content.innerHTML = `
            <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                <div style="font-size: 70px;">ğŸŒˆ</div>
                <h2 style="color:var(--primary); line-height:1.4;">æ˜Ÿæ˜Ÿé›†æ»¿å›‰ï¼<br>ç²å¾—ä¸€å¼µæ–°è²¼ç´™ï¼</h2>
                <div style="font-size: 110px; animation: bounce 1s infinite; margin: 20px 0;">${newSticker}</div>
            </div>
            <button class="btn btn-primary" style="width:100%; height:55px; border-radius:25px;" onclick="closeModal(); ${isSessionOrQuiz ? 'if(reviewQueue.length>0)showNextReview();' : 'render();'}">æ”¶ä¸‹è²¼ç´™ï¼Œç¹¼çºŒå†’éšª</button>
        `;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function checkQuiz(btn, sel, tar) {
        const today = new Date().toISOString().split('T')[0];
        const item = state.characters[tar] || state.words[tar];
        let starAwarded = false;
        
        // é–å®šæ‰€æœ‰æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¦†é»æ“Š
        const btns = document.querySelectorAll('#modal-content .btn-outline');
        btns.forEach(b => b.disabled = true);

        if(sel === tar) { 
            btn.style.backgroundColor="#DFF9FB"; 
            btn.style.borderColor="var(--success)";
            quizData.score++; 
            if (item && item.lastStarDate !== today) {
                state.currentStars++;
                item.lastStarDate = today;
                starAwarded = true;
            }
        } else {
            btn.style.backgroundColor="#FFECEC";
            btn.style.borderColor="var(--danger)";
            // æ•™å­¸å„ªåŒ–ï¼šç­”éŒ¯æ™‚é«˜äº®æ­£ç¢ºç­”æ¡ˆ
            btns.forEach(b => {
                if (b.innerText === tar) {
                    b.style.backgroundColor = "#DFF9FB";
                    b.style.borderColor = "var(--primary)";
                }
            });
        }
        
        save(); 

        if (state.currentStars >= 10) {
            state.currentStars = 0;
            save();
            updateStarMeter();
            setTimeout(() => triggerReward(false), 800); 
        } else {
            const delay = (sel === tar) ? 1000 : 1800; // ç­”éŒ¯ç•™ä¹…ä¸€é»è®“å­©å­çœ‹æ¸…æ¥šæ­£ç¢ºå­—
            setTimeout(() => { 
                if (starAwarded) showNotification("ç­”å°äº†ï¼é­”æ³•æ˜Ÿæ˜Ÿ +1 âœ¨");
                quizData.current++; 
                renderQuizStep(); 
                updateStarMeter(); 
            }, delay);
        }
    }

    function updateStarMeter() {
        const box = document.getElementById('star-box'), needed = document.getElementById('stars-needed');
        if (!box || !needed) return;
        const count = state.currentStars || 0;
        needed.innerText = Math.max(0, 10 - count);
        box.innerHTML = Array(10).fill(0).map((_,i) => `<span style="opacity:${i<count?1:0.2}">${i<count?'â­':'âšª'}</span>`).join('');
        const preview = document.getElementById('sticker-preview');
        preview.innerHTML = '<span style="font-size: 11px; color: #FF7EB9; font-weight: 700;">è²¼ç´™ç°¿ï¼š</span>';
        (state.stickers || []).slice(-12).forEach(s => {
            const span = document.createElement('span'); span.style.fontSize="26px"; span.innerText=s; preview.appendChild(span);
        });
    }

    function calculateSRS(item, rating) {
        let { interval = 0, ease = 2.5, reps = 0, lastStarDate = null } = item;
        const now = Date.now();
        if (rating === 1) { reps = 0; interval = 0; ease = Math.max(1.3, ease - 0.2); }
        else {
            if (reps === 0) interval = (rating === 4) ? 4 : 1;
            else if (reps === 1) interval = 6;
            else interval = Math.ceil(interval * (rating === 2 ? 1.2 : (rating === 4 ? ease * 1.3 : ease)));
            reps++;
            if (rating === 2) ease = Math.max(1.3, ease - 0.15);
            if (rating === 4) ease += 0.15;
        }
        return { interval, ease, reps, nextReview: now + (interval * 86400000), lastStarDate };
    }

    function render() {
        const chars = Object.entries(state.characters), words = Object.entries(state.words);
        const all = [...chars, ...words], now = Date.now();
        document.getElementById('total-count').innerText = all.length;
        document.getElementById('review-count').innerText = all.filter(([k,v])=>v.nextReview<=now).length;
        document.getElementById('streak-count').innerText = state.streak || 0;
        renderCalendar();
        const bar = document.getElementById('fam-bar'); bar.innerHTML = '';
        [{c:'#FFDAB9',f:v=>v.interval>30},{c:'#E2D5F0',f:v=>v.interval>10&&v.interval<=30},{c:'#FAD0C4',f:v=>v.interval>3&&v.interval<=10},{c:'#FFD1DC',f:v=>v.interval>=0&&v.interval<=3}].forEach(t=>{
            const c = all.filter(([k,v])=>t.f(v)).length;
            const s = document.createElement('div'); s.className='fam-seg'; s.style.width=`${(c/(all.length||1))*100}%`; s.style.backgroundColor=t.c; bar.appendChild(s);
        });
        const container = document.getElementById('main-list'); container.innerHTML = '';
        let list = (currentTab==='review') ? all.filter(([k,v])=>v.nextReview<=now) : (currentTab==='words') ? words : all;
        list.sort((a,b)=>a[1].nextReview-b[1].nextReview).forEach(([k,v])=>{
            const card = document.createElement('div'); card.className='char-card'; card.style.backgroundColor=getCardColor(v.interval);
            card.onclick=()=>openSingleFlashcard(k);
            const d = new Date(v.nextReview || now);
            card.innerHTML=`<div class="char-text" style="font-size:${k.length>4?'12px':(k.length>2?'18px':'28px')}">${k}</div><div class="review-date">${d.getMonth()+1}/${d.getDate()}</div>`;
            container.appendChild(card);
        });
        document.getElementById('start-review-btn').className = all.filter(([k,v])=>v.nextReview<=now).length > 0 ? 'btn btn-primary btn-review-alert' : 'btn btn-primary';
    }

    function openSingleFlashcard(k) { renderSRSContent(k, false); document.getElementById('modal-overlay').style.display='flex'; }
    
    function renderSRSContent(k, s) {
        const content = document.getElementById('modal-content'); 
        let fs = k.length===1?'180px':(k.length===2?'130px':(k.length===3?'90px':'70px'));
        content.innerHTML = `
            <button onclick="closeModal()" style="position:absolute;top:20px;right:20px;border:none;background:none;font-size:28px;color:#ccc;">âœ•</button>
            <div class="flashcard-main" style="font-size:${fs}">${k}</div>
            <div style="width:100%;">
                <p style="font-size:10px; color:#A1887F; margin-bottom:10px; text-align:center;">å®¶é•·è¨˜éŒ„ç†Ÿæ‚‰åº¦</p>
                <div class="srs-controls">
                    <button class="srs-btn btn-again" onclick="handleSRS('${k}',1,${s})">å¿˜è¨˜<span>æ˜å¤©è¦‹</span></button>
                    <button class="srs-btn btn-hard" onclick="handleSRS('${k}',2,${s})">å›°é›£<span>å†çœ‹ä¸€æ¬¡</span></button>
                    <button class="srs-btn btn-good" onclick="handleSRS('${k}',3,${s})">è¨˜å¾—<span>ç©©æ­¥é•·å¤§</span></button>
                    <button class="srs-btn btn-easy" onclick="handleSRS('${k}',4,${s})">å¤ªç°¡å–®<span>è·³ç´š</span></button>
                </div>
            </div>`;
    }

    function startReviewSession() {
        reviewQueue = [...Object.entries(state.characters),...Object.entries(state.words)].filter(([k,v])=>v.nextReview<=Date.now()).map(([k,v])=>k).sort(()=>Math.random()-0.5);
        if(reviewQueue.length===0)return showNotification("ğŸ‰ ç›®å‰æ²’å­—è¦è¤‡ç¿’ã€‚");
        showNextReview();
    }

    function showNextReview() { if(reviewQueue.length===0){render();closeModal();return showNotification("ğŸ’– å†’éšªå®Œæˆï¼");} renderSRSContent(reviewQueue[0],true); document.getElementById('modal-overlay').style.display='flex'; }

    function startQuizSession() {
        if(!state.similarPairs || state.similarPairs.length === 0) return showNotification("å…ˆå»è¨­å®šç›¸è¿‘å­—å–”ï¼");
        quizData = { current: 1, total: Math.min(10, state.similarPairs.length), score: 0 };
        renderQuizStep(); document.getElementById('modal-overlay').style.display = 'flex';
    }

    function renderQuizStep() {
        if (quizData.current > quizData.total) return renderQuizResult();
        const pair = state.similarPairs[Math.floor(Math.random() * state.similarPairs.length)];
        const target = Math.random() > 0.5 ? pair.c1 : pair.c2;
        const options = [pair.c1, pair.c2].sort(() => Math.random() - 0.5);
        document.getElementById('modal-content').innerHTML = `
            <div style="position:absolute; top:20px; font-size:14px; color:var(--primary); font-weight:700;">âœ¨ ç¬¬ ${quizData.current} / ${quizData.total} é¡Œ âœ¨</div>
            <div style="margin-top:40px;">æ‰¾åˆ°é€™å€‹å­—ï¼š</div><div class="flashcard-main" style="font-size:130px;margin:20px 0;">${target}</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; width:100%;">${options.map(o=>`<button class="btn btn-outline" style="font-size:65px; padding:25px; border-radius:30px; height:140px; font-weight:700;" onclick="checkQuiz(this,'${o}','${target}')">${o}</button>`).join('')}</div>`;
    }

    function renderQuizResult() { fireConfetti(); document.getElementById('modal-content').innerHTML = `<div class="flashcard-main" style="flex-direction:column; font-size:24px;"><h2 style="color:var(--primary);">ğŸŠ æŒ‘æˆ°å®Œæˆï¼</h2><div style="font-size:80px; margin: 20px 0;">ğŸ†</div><div style="font-weight:700;">å¦³ç­”å°äº† ${quizData.score} é¡Œï¼</div></div><button class="btn btn-primary" style="width:100%; height:55px; border-radius:25px;" onclick="closeModal()">å›ä¸»é çœ‹æœˆæ›†</button>`; save(); }

    function openParentalGuide() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<button onclick="closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc;">âœ•</button><h2 style="color:var(--primary);">ğŸ“– å®¶é•·å°èˆªèªªæ˜æ›¸</h2><div class="guide-section"><h3>ğŸ”’ å…¬å¹³çå‹µæ©Ÿåˆ¶</h3><p><strong>æ¯å€‹å­—æ¯å¤©ä¸è«–æ¨¡å¼åªèƒ½é ˜ä¸€æ¬¡æ˜Ÿæ˜Ÿ</strong>ã€‚é€™èƒ½ç¢ºä¿çå‹µçš„çè²´æ€§ï¼Œä¸¦é˜²æ­¢å­©å­é‡è¤‡åˆ·åˆ†ã€‚</p><h3>ğŸ“… å†’éšªæœˆæ›†</h3><p>ğŸ‘‘ ä»£è¡¨ç•¶å¤©æœ‰ç·´ç¿’ã€‚å»ºè­°èˆ‡å­©å­ç´„å®šé›†æ»¿æ•´å€‹æœˆçš„ç¾å¯¦çå‹µã€‚</p><h3>ğŸ§  è¨˜æ†¶ç§‘å­¸</h3><p>ç³»çµ±è‡ªå‹•è¨ˆç®—è¤‡ç¿’å¤©æ•¸ï¼Œè³‡æ–™ä¹Ÿæœƒè‡ªå‹•ç˜¦èº«ï¼ˆä¿ç•™æœ€è¿‘365å¤©ï¼‰ä»¥ç¶­æŒç³»çµ±æµæš¢ã€‚</p></div><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="closeModal()">äº†è§£äº†</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function openSimilarManager() {
        const listHtml = (state.similarPairs || []).map(p => `<div style="display:flex; justify-content:space-between; align-items:center; width:100%; padding:10px; border-bottom:1px solid #FFF0F5;"><span style="font-size:22px; font-weight:700;">${p.c1} â†” ${p.c2}</span><button onclick="removePair(${p.id})" style="color:var(--danger); border:none; background:none; font-size:18px;">ğŸ—‘ï¸</button></div>`).join('');
        document.getElementById('modal-content').innerHTML = `<button onclick="closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc;">âœ•</button><h2 style="color:var(--primary); margin-bottom:15px;">âš™ï¸ ç›¸è¿‘å­—ç®¡ç†</h2><div style="background:#FFF0F5; padding:20px; border-radius:24px; width:100%; margin-bottom:20px;"><div style="display:flex; gap:10px; justify-content:center;"><input type="text" id="sim-c1" maxlength="1" placeholder="å­—" style="width:60px; text-align:center; padding:10px; border:2px solid #FFD1DC; border-radius:12px; font-size:20px; font-weight:700;"><input type="text" id="sim-c2" maxlength="1" placeholder="å­—" style="width:60px; text-align:center; padding:10px; border:2px solid #FFD1DC; border-radius:12px; font-size:20px; font-weight:700;"><button class="btn btn-primary" onclick="addPair()">æ–°å¢</button></div></div><div style="width:100%; max-height:300px; overflow-y:auto;">${listHtml || '<p style="text-align:center; color:#ccc;">è¨­å®šå®¹æ˜“æ··æ·†çš„å­—çµ„</p>'}</div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function addPair() {
        const c1 = document.getElementById('sim-c1').value.trim(), c2 = document.getElementById('sim-c2').value.trim();
        if(c1 && c2 && c1 !== c2) { state.similarPairs.push({id:Date.now(), c1, c2}); save(); openSimilarManager(); render(); }
    }
    function removePair(id){ state.similarPairs = state.similarPairs.filter(p=>p.id!==id); save(); openSimilarManager(); render(); }
    
    function openStickerWall() {
        const count = (state.stickers || []).length;
        const stickerHtml = (state.stickers || []).map(s => `<div style="font-size:48px; cursor:pointer;" onclick="this.style.transform='scale(2)';setTimeout(()=>this.style.transform='scale(1)',300)">${s}</div>`).join('');
        const wishesHtml = (state.wishes || []).map(w => {
            const pct = Math.min(100, (count / w.count) * 100);
            return `<div class="wish-item"><div class="wish-header"><span>ğŸ ${w.text}</span><span>${count} / ${w.count}</span></div><div class="wish-progress-bg"><div class="wish-progress-fill" style="width:${pct}%"></div></div><button onclick="removeWish(${w.id})" style="background:none; border:none; color:#ccc; font-size:10px; margin-top:5px;">ğŸ—‘ï¸ ç§»é™¤</button></div>`;
        }).join('');
        document.getElementById('modal-content').innerHTML = `
            <button onclick="closeModal()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:28px; color:#ccc;">âœ•</button>
            <h2 style="color:var(--primary); margin-top:10px;">âœ¨ å¦¹å¦¹çš„å¤¢å¹»è²¼ç´™ç‰† âœ¨</h2>
            <div style="margin: 10px 0; font-size:12px; color:#8d6e63;">å¦³ç¸½å…±æ”¶é›†äº† <strong>${count}</strong> å¼µè²¼ç´™ï¼</div>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; width:100%; padding:20px 0; min-height:100px;">
                ${stickerHtml || '<p style="grid-column:span 4; color:#ccc;">è¶•å¿«å†’éšªæ”¶é›†è²¼ç´™å§</p>'}
            </div>
            <div style="width:100%; background:#FFF0F5; padding:20px; border-radius:28px; margin-top:auto;">
                <h3 style="font-size:14px; color:var(--primary); margin-bottom:15px; text-align:center;">ğŸŒŸ é­”æ³•é¡˜æœ›æ¸…å–®</h3>
                ${wishesHtml}
                <div style="margin-top:15px; border-top:1px dashed #FFD1DC; padding-top:15px;">
                    <input type="text" id="new-wish-text" placeholder="è¼¸å…¥é¡˜æœ›..." style="width:100%; padding:8px; border:1px solid #FFD1DC; border-radius:10px; margin-bottom:8px; font-size:12px;">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="new-wish-count" placeholder="éœ€å¹¾å¼µ?" style="width:60%; padding:8px; border:1px solid #FFD1DC; border-radius:10px; font-size:12px;">
                        <button class="btn btn-primary" onclick="addWish()" style="flex:1;">â•</button>
                    </div>
                </div>
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function addWish() {
        const text = document.getElementById('new-wish-text').value.trim();
        const count = parseInt(document.getElementById('new-wish-count').value);
        if(text && count) {
            if(!state.wishes) state.wishes = [];
            state.wishes.push({ id: Date.now(), text, count });
            save(); openStickerWall();
        }
    }

    function removeWish(id) {
        state.wishes = (state.wishes || []).filter(w => w.id !== id);
        save(); openStickerWall();
    }

    function quickAdd(t) {
        const i = document.getElementById(t==='char'?'add-char-input':'add-word-input'), v = i.value.trim(); if(!v)return;
        const now = Date.now(); if(t==='char') Array.from(v).forEach(c=>{if(!state.characters[c])state.characters[c]={interval:0,ease:2.5,reps:0,nextReview:now,lastStarDate:null}});
        else { state.words[v]={interval:0,ease:2.5,reps:0,nextReview:now,lastStarDate:null}; Array.from(v).forEach(c=>{if(!state.characters[c]&&/[\u4e00-\u9fa5]/.test(c))state.characters[c]={interval:0,ease:2.5,reps:0,nextReview:now,lastStarDate:null}});}
        i.value=''; save(); render(); showNotification('å¤¥ä¼´åŠ å…¥å›‰ï¼');
    }

    function setTab(t, e) { currentTab=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); e.classList.add('active'); render(); }
    function closeModal(){document.getElementById('modal-overlay').style.display='none';}
    function showNotification(m){const d=document.createElement('div');d.className='notification';d.innerText=m;document.getElementById('notification-container').appendChild(d);setTimeout(()=>d.remove(),2000);}
    function exportData(){const a=document.createElement('a');a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state));a.download=`å¦¹å¦¹èªå­—_${new Date().toISOString().slice(0,10)}.json`;a.click();}
    function importData(event){const f=event.target.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.learners&&d.learners.sister){const sis=d.learners.sister.data.characters;state.characters={};state.words={};Object.entries(sis).forEach(([k,v])=>{const i = (v.level===4?60:v.level===3?14:v.level===2?7:v.level===1?3:0); state.characters[k]={interval:i,ease:2.5,reps:v.level||0,nextReview:v.nextReview||Date.now(),lastStarDate:null};});}else state=d;save();render();updateStarMeter();showNotification('è¼‰å…¥æˆåŠŸï¼');}catch(x){showNotification('éŒ¯èª¤');}};r.readAsText(f);}
</script>
</body>
</html>
